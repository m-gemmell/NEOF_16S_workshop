---
title: "Bacterial 16S metabarcoding"
author: "Luca Lenzi and Matthew R. Gemmell"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
favicon: figures/NEOF_favicon.png
description: NEOF book for the Bacterial 16S metabarcoding workshop
cover-image: "figures/NEOF.png"
---
```{r include=FALSE, cache=FALSE}
library(webexercises)
```

```{r cite-packages, include = FALSE}
# automatically create a bib database for R packages
# add any packages you want to cite here
knitr::write_bib(c(
  .packages(), 'bookdown', 'webexercises'
), 'packages.bib')
```

```{r, echo=FALSE}
#Change colour, border, and text of code chunks
#Check style.css for .Rchunk
#https://stackoverflow.com/questions/65627531/change-r-chunk-background-color-in-bookdown-gitbook
#https://bookdown.org/yihui/rmarkdown-cookbook/chunk-styling.html
knitr::opts_chunk$set(class.source="Rchunk") 
```

```{r, fig.align = 'center',out.width= '30%', echo=FALSE }
knitr::include_graphics(path = "figures/NEOF_bordered.png", auto_pdf = TRUE)
```

# Introduction

```{r, fig.align = 'center',out.width= '30%', echo=FALSE }
knitr::include_graphics(path = "figures/intro_logo.png", auto_pdf = TRUE)
```

Sequencing of the 16S rRNA gene is a well established method of determining the bacterial taxonomic composition of microbiomes. This has been used for human and animal body sites, soil, sewage, clouds, deserts, permafrost and many other environments. This course will give you the ability to describe the advantages and disadvantages of 16S rRNA sequencing, and analyse 16S rRNA datasets with the QIIME2 bioinformatics platform.

Sessions will start with a brief presentation followed by self-paced computer practicals guided by an online interactive book. The book will contain theory and practice code. Multiple choice questions will guide the interpretation of results.

At the end of the course learners will be able to:

- Utilise and understand the use of QIIME2 with 16S rRNA data.
- Import sequencing data and metadata into QIIME2 artifacts.
- Cluster and denoise 16S sequences with DADA2.
- Assign taxonomies to ASVs and produce a phylogenetic tree.
- Evaluate and normalise sequencing depth across their samples.
- Produce alpha and beta diversity metrics and statistics.
- Carry out differential abundance analysis.

There are [supplementary materials](https://neof-workshops.github.io/16S_yg84o9/Supplemental/01-16S_supplemental.html) including exporting of QIIME2 artifacts, various handy QIIME2 commands, and introduction to some useful R packages. These can be run through after the course by the learner.

## Table of contents {-}

```{r, echo=FALSE, align="centre"}
#Create 2 coilumn dataframe
column_1 <- c(
 '[**Background on the biology**](#background)', 
 '[![](figures/background.png){height="150"}](#background)',
 '[**Cluster and webVNC information**](#cluster)',
 '[![](figures/cluster.png){height="150"}](#cluster)',
 '[**QIIME2 analysis workflow**](#q2workflow)',
 '[![](figures/workflow.png){height="150"}](#q2workflow)',
 '[**PCR primer trimming**](#pcrtrim)',
 '[![](figures/prepare.png){height="150"}](#pcrtrim)',
 '[**Taxonomic classification**](#taxa)',
 '[![](figures/classification.png){height="150"}](#taxa)',
 '[**Rarefaction curve**](#rarefaction)',
 '[![](figures/rarefaction.png){height="150"}](#rarefaction)',
 '[**Differential abundance analysis**](#differential)',
 '[![](figures/balance_scale.png){height="150"}](#differential)',
 '[**Appendix**](#resources)',
 '[![](figures/resources.png){height="150"}](#resources)'
)
column_2 <- c(
  '[**Introduction to QIIME2**](#introqiime2)',
 '[![](figures/intro_logo.png){height="150"}](#introqiime2)',
 '[**Introduction to QIIME2**](#introqiime2)',
 '[![](figures/data_files.png){height="150"}](#data)',
 '[**Sequence import**](#import)',
 '[![](figures/import.png){height="150"}](#import)',
 '[**DADA2 denoising**](#dada2)',
 '[![](figures/clusters.png){height="150"}](#dada2)',
 '[**Phylogenetic tree construction**](#phylogeny)',
 '[![](figures/phylo_tree.png){height="150"}](#phylogeny)',
 '[**Alpha and beta diversity analysis**](#diversity)',
 '[![](figures/diversity.png){height="150"}](#diversity)',
 '[**Final considerations**](#final)',
 '[![](figures/finish.png){height="150"}](#final)',
 "",""
)
table_df <- data.frame(column_1, column_2)
#Kable and kableextra libraries
library(knitr)
library(kableExtra)
#Create table
#ALign both column in centre (align = "cc")
table_df %>%
  kbl(align= "cc", col.names = NULL) %>%
  kable_styling(position = "center")
```

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="Creative Commons Licence" style="border-width:0"/></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

<!--chapter:end:01-Bacterial_16S_metabarcoding.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Background {#background}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/background.png", auto_pdf = TRUE)
```  
One of the most common aims of metagenomic analyses is to quantify the composition and diversity of a community (usually a community of prokaryotes). This can be done in several ways. A common approach is high-throughput amplicon sequencing, usually of a region of the bacterial 16S SSU rRNA gene. Another approach is shotgun metagenomic sequencing, where the whole genomic content of a sample is sequenced.

In the first approach, amplicons act as ‘tags’ identifying the different bacterial species present in the sample, which can be both identified and quantified to describe the composition of the bacterial community (also called _metagenetics_ or _metaprofiling_). In the second approach, whole genomes, rather than just representative amplicons, are sequenced (_shotgun metagenomics_). This DNA can be assembled, or the source of the reads can be identified and quantified in a broadly similar way to 16S analysis.

In this workshop, we will analyse amplicon sequencing data, obtained by amplification of the variable region 4 of the 16S gene, using primer 515FB-806RB (Caporaso _et al_, 2011). The sequences were obtained from the Illumina MiSeq platform, 2x250bp reads, and the analysis process will be based on the software package QIIME2 ("Quantitative Insights Into Microbial Ecology", https://qiime2.org). We will explore the bacterial populations sampled at various locations in the University of Liverpool's Bioscience building: toilets and corridors from different floors.

## 16S rRNA

16S ribosomal RNA is a structural RNA which is a component of the prokaryotic ribosome. Ribosomes are the site of protein synthesis, therefore all prokaryotes have at least a 16S rRNA gene that codes for the 16S ribosomal RNA.

The 16S rRNA gene is utilised in reconstructing phylogenies due to its slow rate of evolution, its size and its functional constancy. If the function of 16S rRNA changed then the cell could not synthesise proteins correctly and so will not survive.

The 16S rRNA gene is ~1,500bp long and consists of 9 variable regions separated by conserved regions. The variable regions evolve at a faster rate allowing differentiation between bacterial taxa. The conserved regions evolve at a slower rate which allows areas to carry out universal amplification on the gene. The nine variable regions are generally called V1, V2, V3 etc.

```{r, fig.align = 'center',out.width= '60%', echo=FALSE }
knitr::include_graphics(path = "figures/16srna.png", auto_pdf = TRUE)
```  
Secondary structure of 16S rRNA of Esherichia coli (Yarza _et al_, 2014)

## ITS and other possible marker genes
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/ITS.png", auto_pdf = TRUE)
```  
It is very common to perform analysis with marker genes other than 16S, e.g. to study communities of fungi, insects or any other eukaryote species. From the perspective of the bioinformatics analysis, the same overall pipeline can be used for most of the marker genes. 

ITS (Internal Transcribed Spacer) is a commonly used marker alternative to 16S. QIIME2 can be used to analyse ITS with a few steps and commands required which are unnecessary for 16S rRNA data. In this  tutorial, locations will be highlighted where you should consider a pipeline variation if you are using ITS. In general, we recommend searching the literature so you can be aware of the state-of-the-art methods for the analysis of your marker of interest.

## Amplicon sequencing

The use of high-throughput amplicon-sequencing has proven to be powerful and accurate for microbial community analysis. It is currently the preferred choice used to investigate biological communities (bacterial or eukaryotic) in many samples and conditions. 

Some of the reasons for this method's popularity are:

- It is relatively easy to perform.
- It can be performed with many samples.
- It is relatively fast and cheap.

On the negative side, there are many steps which may potentially introduce biases in the final result:

- Experimental design, sampling, storage and DNA extraction methods are known to potentially reduce the initial bacterial population processed and sequenced. 
- Any reagent used may add exogenous bacterial population to the samples (potentially contaminating or changing the initial bacterial amount).
- Several papers discuss how the PCR protocol used for the amplification of the DNA material may affect the final results (such as the creation of chimeric sequences or by preferentially amplifying certain bacterial species). 
- The choice of sequencing platform may result in the identification of different species in the same samples by having its own characteristic error-profile.
- From the bioinformatics perspective, the length of the sequences, and the pipeline used for the analysis are also able to add variability to the final results.
- The identification of the species in the samples can be affected by the quality and completeness of the database used for the analysis. Additionally, it may become less precise at lower taxonomy levels such as ‘genus’ and ‘species’ (Hugerth and Andersson, 2017).

All these aspects need to be taken into account in the discussion of the results.

```{r, fig.align = 'center',out.width= '90%', echo=FALSE }
knitr::include_graphics(path = "figures/amplicon_sequencing_representation.png", auto_pdf = TRUE)
```
Above shows a representation of amplicon sequencing.

A) Different species are shown as different colours, with the indication of which species are in the site under investigation. Some species may be excluded from the sequencing because they are:
   - Missed by the sampling methods (purple dots)
   - Lost during the sample preparation (outside green square)
   - Lost by the extraction technique (outside green square)
   - Not amplified in the PCR step (outside red square)
B) Representation of the number of sequences obtained for a sample, showing that increasing the number of sequences increases the probability to retrieve low-abundant species in the samples. The main purpose for this analysis is to infer the number and type of species in the initial sampling site by the abundance of the sequences obtained by the sequencing experiment. In order to do this effectively, the use of mock communities and negative controls is strongly suggested to evaluate the effect of any possibly introduced bias. Additionally, normalisation of the data is absolutely necessary to compare the diversity between sample groups.

<!--chapter:end:02-Background.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Introduction to QIIME2 {#introqiime2}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/q2docs_bordered.png", auto_pdf = TRUE)
``` 

Since January 2018, the QIIME project released the QIIME2 (qiime2.org, Bolyen et al., 2018) pipeline to analyse amplicon sequencing data. The QIIME1 scripts, in its latest release QIIME1.9.1, are still available (and their methods are still valid) however the suggestion is to use QIIME2, as QIIME1 is no longer supported. In the following practical we will use the QIIME2 released on February 2021 (given the active development on the tool this may not be the most recent release at the time of this workshop). 

If you want to install QIIME2 on your own machine, please refer to: 
https://docs.qiime2.org/2021.2/install/

## Artifacts
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/artefact.png", auto_pdf = TRUE)
``` 

The QIIME2 pipeline produces and uses ‘artifact’ files. These contain data and metadata and may be of two types: result or visualisation. 

- __Result files (.qza)__: This file type contains the results of a method, which accepts other ‘artifacts’ and specific settings as input, in order to apply a procedure creating a new artifact (e.g. loading sequences, error correction, alpha- or beta-diversity).
- __Visualisation files (.qzv)__: This file type contains the results of a specific procedure to obtain an object that can only be used to visualize the results. These files can be loaded into the following web-site https://view.qiime2.org, where the interactive visualisations can be viewed. Please note that only chrome and Firefox are supported by this QIIME2 website.

## Workflow
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/workflow.png", auto_pdf = TRUE)
``` 

The steps for the analysis are listed below, mainly taken from https://docs.qiime2.org/2021.2/tutorials/.

```{r, fig.align = 'center',out.width= '80%', echo=FALSE }
knitr::include_graphics(path = "figures/16_tutorial_diagram.png", auto_pdf = TRUE)
``` 
Representation of the step proposed for the analysis (http://compbio.ucsd.edu/wp-content/uploads/2016/10/20170712_microbiome_16s_tutorial_non-interactive.pdf)

1. Prepare the sequence dataset
    a. Remove PCR primers
2. Amplicon Sequence Variants identification
3. Assign a taxonomic classification to each ASV
    a. Train naive-classifier for assignment
    b. Taxonomy assignment of the identified ASVs
4. Make a phylogeny tree for the ASVs 
    a. Alignment of the ASV representative sequences 
    b. Masking low quality alignment 
    c. Creating the un-rooted phylogenetic tree 
    d. Creating the rooted phylogenetic tree 
5. Summarise the taxonomy data for each sample and plot results 
6. Estimate and plot alpha diversity 
7. Estimate and plot beta diversity
8. Differential abundance analysis

## Prepare the sequence dataset
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/prepare.png", auto_pdf = TRUE)
``` 

The read set you will be using in this tutorial will be a raw dataset. It still includes low quality sequences, Illumina sequencing adapters as well as PCR primers. Before proceeding with the analysis, it is a good strategy to investigate the quality of the sequences. 

The PCR primers used for the amplification may have degenerate positions (required for annealing to the large variety of species in the samples). This adds 'random' variability outside the target region. These unknown sequences may affect the subsequent taxonomy identification as well as the error-correction step. We will use Cutadapt to remove the PCR primers before any other step. 

If the analysis is based on a marker gene different than 16S, other quality trimming may be required. In the case of the ITS marker gene, the common practice is to trim off the conserved regions (SSU, 5.8S or LSU) that may be contained in the final amplicon. The ‘ITSxpress’ software (Rivers _et al_., 2018) is designed for this specific task and it is available as a QIIME2 plug-in,  though it requires specific installation steps because it is not installed with the basic (core) installation process. It could be found among the list of third-party QIIME2 available plug-ins (https://library.qiime2.org/plugins/ ).

## Amplicon Sequence Variants identification

The key element of this type of metagenomic analysis is the identification of the different rRNA variants in the sample. 

### OTUs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/clusters.png", auto_pdf = TRUE)
``` 

The most used procedure to identify OTUs (Operational Taxonomic Units) is through the clustering of reads into groups that are sufficiently similar to one another. These grouped reads are likely to come from the same rRNA gene, genome or taxa group. 

The identified OTUs are a feature of the sequence dataset, heavily dependent on the similarity level used for OTU identification. The most commonly used threshold is 3% dissimilarity (i.e 97% similarity) to group reads into species OTUs. Therefore, de novo OTUs identified in two different data sets cannot be compared. 

There is no single perfect tool for this step; but a few of the most widely used are:

- UCLUST (the default used by QIIME1.9.1)
- VSEARCH
- CD-Hit
- SWARM (if you work with QIIME1.9.1 we recommend using SWARM for this step)

The number of reads in each OTU should reflect the number of copies of the gene in the sample, thus providing a quantitative measure of diversity. 

### ASVs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/mangify_glass.png", auto_pdf = TRUE)
``` 

There are now many bioinformatics methods to resolve amplicon sequence variants (ASVs) from Illumina data. These methods do not impose the arbitrary dissimilarity thresholds that define molecular OTUs. The two methods available in QIIME2 are DADA2 and deblur.

ASV methods infer the biological sequences in the sample prior to the introduction of amplification and sequencing errors, and distinguish sequence variants differing by as little as one nucleotide. The methods use a de novo process in which biological sequences are discriminated from errors on the basis of, in part, the expectation that biological sequences are more likely to be repeatedly observed than error-containing sequences.

Unlike de novo OTUs, ASVs are consistent labels because ASVs represent a biological reality that exists outside of the data being analysed: the DNA sequence of the assayed organism. Thus, ASVs inferred independently from different studies or different samples can be compared.

The following picture shows how DADA2 (an ASV method) and OTU processes compare to each other. This shows how the canonical creation of OTUs by clustering may lead to an overestimation of the size of the OTUs due to the presence of errors, from either PCR or sequencing.

```{r, fig.align = 'center',out.width= '80%', echo=FALSE }
knitr::include_graphics(path = "figures/ASC_otu_comparison.png", auto_pdf = TRUE)
``` 

Much of the work involved in the analysis of amplicon-based metagenomic data is that of separating true variants from errors introduced by sequencing. These errors include miscalling of nucleotides and the generation of chimeric sequences.

For sequencing purposes, an aliquot of PhiX phage DNA is added to each sample before sequencing, both DADA2 and deblur include a step aimed to exclude any PhiX associated reads. To remove PCR chimeric artefacts, a further filter step is applied by both. 

QIIME 2 Authors suggest using DADA2 for read pairs and ‘deblur’ for already paired (stitched/joined) sequences. Please note that it is good practice to remove/trim out sequences containing Ns before the error correction step. It is not suggested to denoise with DADA2 samples from different sequencing lanes, because each lane may introduce different sequencing biases. It is possible to collate the denoised abundance tables and representative sequences afterwards, recording the sequencing lane for each sample in a specific metadata column. The ‘deblur’ denoise tool may be used in this case because it should be less sensitive to these possible biases, however it is good practice to keep the lane of origin in the metadata (with the second benefit that ‘deblur’ is also faster than ‘DADA2’).

## Assign a taxonomic classification to each ASV
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/classification.png", auto_pdf = TRUE)
``` 

The sequence of each ASV is compared with the selected database, to identify the most likely taxonomy for each ASV. Unfortunately different parts of the taxonomic identification step may lead to different results for the same ASV. 

Different databases may result in different taxonomic classification for the same ASV. The choice of tool used for taxonomic assignment may also impact the results in a similar way. The current version of QIIME2 allows you to select from either the Scikit-learn classifier (a classifier which applies a machine learning approach and therefore needs training before use) or BLAST+ and VSEARCH (for a global alignment approach followed by a last common ancestor search) for this step. 

In the practical we will use Scikit-learn (similar to the RDP tool widely used so far). It has been shown that (at least in the case of 16S analysis) taxonomic classification accuracy improves when the classifier is trained with sequences derived from the amplicon region only (Werner _et al_., 2012).

## Phylogenetic tree creation
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/phylo_tree.png", auto_pdf = TRUE)
``` 

To include phylogenetic diversity metrics in the diversity analysis, such as UniFrac distance metrics, the construction of a phylogenetic tree for the identified ASVs is required. QIIME2 supports MAFFT for the alignment and MASK to mask the alignment sections that are not phylogenetically informative. Unrooted and rooted trees may be created. 

For some marker genes it is not possible to build a phylogenetic tree (ITS is among these), and it is therefore important to know the properties of the marker in use. Consequently, it is not possible to use any diversity metrics that requires the phylogenetic distance as input.

## Data normalisation
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/normalisation.png", auto_pdf = TRUE)
``` 

Any further analyses to compare the identified ASVs among sample groups (either alpha- or beta-diversity or differential abundance) should account for the features of the abundance table that can cause erroneous results (Weiss et al., 2017). These features are:

1. The microbial community in each sample may be represented by different numbers of sequences (i.e. sequencing depth for each sample).
2. The abundance table is usually sparse. That is, most of the ASVs are present only in a few samples and therefore the abundance table contains many ‘0’ values (it is also possible that a particular species is present in a sample but below the detection limit of the methods).
3. The total number of sequences obtained reflect the relative abundance of species sequenced rather that the absolute abundance of the species present in the sample (this is commonly referred as ‘compositional nature’ of the data). The relative abundances for the taxa are therefore not independent as in the underlying assumption of many frequently used statistical methods (Gloor _et al_., 2017).

A normalisation step for the data is required to mitigate these effects and to allow an easier data interpretation. The most used normalisation methods are: 

a. Normalisation by rarefaction. This is performed by reducing all the samples at the same sequence count, by random sub-sampling of the sequences.
    - This method may lead to a potential reduction of the species in your dataset (alpha-diversity) and to the exclusion of any samples not reaching the selected total count per sample.
b. DESeq method (borrowed from transcriptomic research)
c. Scaling the abundance table by a fixed value or proportion.
d. Applying a log-ratio transformation proposed by Aitchinson (1982) in analogy of compositional dataset. 
    - This is aimed to convert the abundance data into scales on which it is possible to apply conventional statistical procedures.
    
Methods b-d convert the abundance table in a normalised-abundance table with different strengths and pitfalls, therefore they can affect results for beta-diversity and differential abundant analysis.

These normalisation methods were compared by Weiss and colleagues (2017), but their simulations show that different methods may result in different sensitivity and different false discovery rates.

In this tutorial, following the QIIME2 current tutorial, we will apply the ‘rarefaction’ method, in the context of the alpha- and beta-diversity analysis.

## Alpha-diversity
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/alpha_div.png", auto_pdf = TRUE)
``` 
Alpha-diversity is used to measure the diversity within a sample. It is calculated as a value for each sample. Different metrics were developed to calculate diversity in different ways. It combines richness (a measure of the number of features in the sample) and evenness (a measure of the relative abundances of different features that make up the richness of that sample). Alpha diversity measures cannot be compared unless they have been normalised for the difference in sequencing depth between samples. The QIIME2 release we will use supports the following alpha-diversity measures, amongst others: Chao1, Shannon, Simpson, Simpson evenness, Faith’s Phylogenetic Diversity (the only one considering the phylogenetic relationships among the
ASVs).

The alpha-diversity metric used for the analysis must be chosen carefully, considering its mathematical definition in relation to the behaviour of the tools used for the previous steps. An important point to consider is whether the chosen metric uses ASVs with only 1 sequence (‘singletons’) to perform some estimation on the dataset or not. The Chao1, as one example for this, uses the number of singletons in the dataset to infer the total number of singletons in the population. However, the DADA2 denoising step excludes ‘singletons’ from the final output, making Chao1 measures not applicable to its resulting abundance tables. A second consideration regards if the phylogenetic tree is available enabling the use of the Faith’s Phylogenetic Diversity metric, for markers such as ITS this metric would not be possible.

## Beta-diversity
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/beta_div.png", auto_pdf = TRUE)
``` 
Beta-diversity is a term for the comparison of samples to each other. It is also referred as beta-diversity ordination, because it uses one (or more) technique/s to arrange samples along axes on the basis of their composition to highlight the differences. The current QIIME2 release supports only the Principal Coordinates Analysis (PCoA) method to investigate beta-diversity (within the old QIIME1 pipeline you could perform NMDS as well). The starting point of the analysis is a dissimilarity matrix, which is used to perform a Principal Component Analysis (PCA) to reduce the dimension for display purpose. The axes obtained from the PCA analysis are then compared with the categories in the metadata file to identify patterns. 

A few of the commonly used beta diversity metrics supported by QIIME2 are:

- Jaccard: A non-phylogeny based method that takes into account the presence/absence of ASVs to measure the distance between two samples.
- Bray-Curtis: A non-phylogeny based method that takes into account the number of ASVs and their abundance to determine the distance between two samples.
- Un-weighted UniFrac: Uses the presence and absence of ASVs and their phylogenies.
- Weighted UniFrac: Uses the abundance information of ASVs and their phylogenies.

As discussed for the alpha-diversity, before proceeding with the beta-diversity analysis the raw abundance table for the identified ASVs needs to be normalised. QIIME2 suggests using the rarefaction methods, in particular at the same rarefaction threshold used for the alpha diversity.

The choice of the beta-diversity distance metric to use will strongly affect the results. Therefore it is common practice to compare the results obtained with different metrics. Again, not all the metrics may be applicable to all the marker genes. E.g. the UniFrac distances could not be easily used in the case of ITS, because ITS sequences are quite difficult to align onto phylogenetic trees.

## Differential Abundance Analysis
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/comparison.png", auto_pdf = TRUE)
``` 

The identification of taxa that are differentially abundant across experimental conditions may be an important result for many types of metagenetics analyses. This step is extremely dependent on the normalization methods used to compare the samples: using different normalisation methods may lead to different results (consequently this is another active area of research).

QIIME2 supports two methods to investigate differentially abundant taxa across experimental conditions: ANCOM (Mandal et al., 2015) and GNEISS (Morton et al, 2017). Both methods are based on the conversion of the abundance values using the clr-transformation method prior to any comparison. Because the conversion is based on a logarithmic transformation, all the values in the abundance table will be increased by ‘1’ to avoid ‘0’ counts (adding pseudo-counts). These methods may therefore artificially increase the alpha-diversity for the samples as well as decrease the beta-diversity distances in the dataset. In this analysis we will use the ANCOM method following the current QIIME2 tutorial. This method computes the log-ratio for every possible pair of the identified taxa (using the mean group values for the clr-transformed abundance) and reports how many times the hypothesis “H 0 = X is not differentially abundant” is rejected for each taxa ‘X’. That is the ‘W’ statistic, the higher this value is the more significant the ASV/taxa X is differentially abundant between the tested groups. This test assumes that a large number of ASVs did not change in abundances between groups. If, in the results, more than 25% of the ASVs changes in the examined contrasts, the underlying hypothesis for the ANCOM test may be not fulfilled, and there is the chance that the results may be misleading.

Examples of questions to answer:

- Are there differences in taxa at various levels of taxonomy?
- What are the most abundant ASVs (or species)?
- What are the rare ASVs present (either real or still retained sequencing error)?
- Where are the rare ASVs present (if not sequencing error)?
- ASVs correlation: is there a correlation between ASVs and other attributes of samples, like pH or other environmental conditions?

<!--chapter:end:03-Intro_to_qiime2.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Cluster Introduction {#cluster}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/cluster.png", auto_pdf = TRUE)
``` 

## Logon instructions
For this workshop we will be using Virtual Network Computing (VNC). Connect to the VNC with a browser by using the webVNC link you were sent.

You will now be in a logged-in Linux VNC desktop with two terminals. You will see something as below (there may be only one terminal which is fine). If you do not see something similar please ask for assistance.
```{r, fig.align = 'center',out.width= '700px', echo=FALSE }
knitr::include_graphics(path = "figures/logon_pic.png", auto_pdf = TRUE)
``` 

If the VNC is taking up too much/little space of your browser you can use the zoom of your browser to adjust the size. Ensure you can see one whole terminal.

These instructions will not work outside of this workshop. If you would like to install your own Linux OS on your desktop or laptop we would recommend Mint Linux 

The following link is a guide to install Mint Linux:  
https://linuxmint-installation-guide.readthedocs.io/en/latest/

## The Terminal Window
In our case the terminal window looks like the picture below. We are using the terminal window as our shell to interpret our commands to the kernel. Depending on your system and preferences it may look different.
```{r, fig.align = 'center',out.width= '800px', echo=FALSE }
knitr::include_graphics(path = "figures/terminal_window.png", auto_pdf = TRUE)
``` 

Already there is useful information for us on the terminal window.

- __nsc006__: This is the login name, also known as the username. In this case nsc006 is a demonstrator's account. Your screen should show a different account name which will be your username for the Linux machine/cluster you are logged into.
- __gauss03__: This is the machine name the user is logged into.
- __\~__: This represents the current directory of the user, or the directory a command was run in. In the Linux OS and others __'~'__ is a shortcut to the user's home directory.
- Everything after the __'$'__ is where commands are typed into the terminal. This is also referred to as the command line.

__To open a new terminal window__, right click on the main screen, choose `Applications` -> `Shell` -> `bash`

<!--chapter:end:04-Cluster_Introduction.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Data {#data}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/data_files.png", auto_pdf = TRUE)
``` 

Prior to starting analysis you will need three files. To acquire these three files run the following commands.

```{bash eval=FALSE}
#Change directory to home
cd ~
#Make a directory in home called "Metagenetics"
mkdir Metagenetics
#Change directory to "Metagenetics"
cd Metagenetics
#Copy the contents of a directory to your current directory
cp /pub14/tea/nsc206/NEOF/16s_workshop/chapter_5/* .
```

Look at the contents of your current directory and then continue reading for explanations on their contents.

```{bash, eval=FALSE}
ls
```

## PairedEndFastqManifestPhred33.csv {#manifestfile}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/manifest.png", auto_pdf = TRUE)
``` 

This "manifest" file contains three columns that are separated by commas (.csv = comma separated values). This is vital for importing your sequencing data into QIIME2.

Each column has a header and contains the following information:

1. __sample-id__
   - User specified sample-id. 
   - This is how the sample will be named in all downstream QIIME2 files.
   - These must match the sample ids in the metadata file.
   - Recommendations for sample ids/identifiers can be found lower down in this bookdown page.
2. __absolute-filepath__
   - Full path of sequencing file.
3. __direction__
   - Direction of the sequencing reads
   - For paired end reads this will be "forward" (R1) or "reverse" (R2).
   
For paired end read datasets there will be two lines for each sample. One for the forward read file and one for the reverse read file. These two lines must have the same sample-id.

Have a look at the "manifest" file. You will see the header followed by all the forward reads then the reverse reads.

__Tip__: Type `q` to quit `less`

```{bash, eval=FALSE}
less PairedEndFastqManifestPhred33.csv
```

This file will be used in chapter 7.

## metadata.file.txt
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/tags.png", auto_pdf = TRUE)
``` 

This file contains metadata. It consists of columns separated by tabs. 

It is vital that the "sample-id" column contains the same info as the "sample-id" column in "PairedEndFastqManifestPhred33.csv".

This file can contain as many columns as you would like (minimum of 2). The first column must be the "sample-id" column.

The first 2 rows must be:

1. Headers
   - Name of metadata fields.
   - These are chosen by the user (except the sample-id column). Ensure these are informative and concise.
   - We suggest to only use letters and not to use spaces.
2. Column type
   - The value "#q2:types" must be used for the 1st column.
   - For all other columns the value must be:
      - "categorical": For categorical metadata.This will be the most common choice.
      - "numeric": For numerical metadata. 
      
Have a look at the top 10 lines of the metadata file:

```{bash, eval=FALSE}
head metadata.file.txt
```
   
For more information on QIIME2 metadata please see: https://docs.qiime2.org/2023.5/tutorials/metadata/

The above link includes:

- Metadata Formatting Requirements
- Info on empty rows
- Recommendations for identifiers
- Info on column types and number formatting
- More

## primers_seqs.fasta

This is a fasta file containing the forward and reverse 16S rRNA primer sequences. These are needed for the PCR trimming step (chapter 8) and the classifier training step (chapter 10).

This file has been provided so you can copy and paste the sequences from within the webVNC. It is never advisable to try to type sequences.

For your own projects you will need to ask the lab that carried out the sequencing preparation for the primer sequences.

<!--chapter:end:05-Data.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# QIIME2 analysis workflow {#q2workflow}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/workflow.png", auto_pdf = TRUE)
``` 

## Workflow

The 'QIIME2' analysis workflow comprises of nine steps:

1. Import sequences into QIIME2 artifact
2. Trim the PCR primer sequences
3. De-novo amplicon sequence variants identifications
4. Assign taxonomic classification to each ASV
5. Create a phylogenetic tree of the identified ASVs
6. Sequencing depth evaluation: rarefaction plot
7. Diversity analysis: alpha and beta
8. Differential abundance analysis of ASVs across different conditions

## Activate environment
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/mamba_logo.png", auto_pdf = TRUE)
``` 
You will need to activate the QIIME2 `mamba` environment before continuing. Carry this out with the following command.

__Note__: Ensure you include the dot and space (`. `) at the start before `useqiime2-2023.5`

```{bash eval=FALSE}
. useqiime2-2023.5
```

<!--chapter:end:06-QIIME2_analysis_workflow.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# (PART\*) Preprocessing of data {-}

# Sequence import {#import}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/import.png", auto_pdf = TRUE)
``` 

Before we can work with our data in QIIME2 we need to import the data into a QIIME2 artifact.

## Import: run
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_green.png", auto_pdf = TRUE)
``` 

Import our read pairs into a QIIME2 artifact.

__Note__: It is quite easy to make typos in the following command. Ensure to read any errors carefully to try to figure out where a typo is, if any.

__Note 2__: If you are no familiar with the back slashes (`\`) in the below command please check our explanation of __[Bash escape](https://neof-workshops.github.io/Unix_nxcdf7/Course/05-Tips_and_tricks.html#bash-escape)__. Please also ask for a demonstration if you would like.

```{bash, eval=FALSE}
qiime tools import \
--type 'SampleData[PairedEndSequencesWithQuality]' \
--input-path PairedEndFastqManifestPhred33.csv \
--output-path paired-end-demux.qza \
--input-format PairedEndFastqManifestPhred33
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_green.png", auto_pdf = TRUE)
```

- __`--type`__: The type of data being imported.
  - `'SampleData[PairedEndSequencesWithQuality]'` specifies we are importing Paired end sequence data that contains quality information. I.e. normal Illumina paired end fastq data.
- __`--input-path`__: The input [manifest file](#manifestfile).
- __`--output-path`__: Output QIIME2 artifact file containing your sequence data.
  - The "demux" part of the file name indicates that the samples are already demultiplexed (i.e. sequences have been separated by samples). 
  - QIIME2 artifacts use "-" as word separators in file names.  This is not mandatory but it is a good practice to keep consistent with the QIIME2 developers.
- __`--input-format`__: The format of the input files.
  - `PairedEndFastqManifestPhred33`: Our input file is a Manifest file with information on paired fastq files. Our fastq files have quality encoding of Phred33, the most commonly used for Illumina data now. More information about fastq quality encoding can be found on [wikipedia](#https://en.wikipedia.org/wiki/FASTQ_format#Encoding).
 
[QIIME2 docs on importing data](https://docs.qiime2.org/2023.5/tutorials/importing/)

__Note__: All the QIIME2 links may be out of date and the below will appear:
```{r, fig.align = 'center',out.width= '100%', echo=FALSE }
knitr::include_graphics(path = "figures/qiime2_website_out_of_date.png", auto_pdf = TRUE)
``` 

If this occurs click "Show me the content on this page".

You can then click the version box on the top left (above the table of contents, pictured below) and choose the version you would like. This would be either the version you are using or the latest version.
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/qiime2_version_box.png", auto_pdf = TRUE)
``` 

## Import: visualise {#chap7_vis}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_green.png", auto_pdf = TRUE)
``` 

To visualise the samples loaded, the following command will create a visualisation artifact.

```{bash, eval=FALSE}
qiime demux summarize \
--i-data paired-end-demux.qza \
--o-visualization paired-end-demux.qzv
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_green.png", auto_pdf = TRUE)
```

- __`--i-data`__: Input data artifact (`.qza`) to be summarised and visualised.
- __`--o-visualization`__: Output visualisation artifact (`qzv`).

[QIIME2 docs on `qiime demux summarize`](https://docs.qiime2.org/2023.5/plugins/available/demux/summarize/)

#### Firefox {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/firefox.png", auto_pdf = TRUE)
```

We have created our visualistion file, now we need to visualise it. We carry this out with the website [view.qiime2.org](view.qiime2.org).

First we need to open up `Firefox`. Right click on the main screen (greyish background) and choose `firefox` from the dropdown menu.

Then:

- Navigate to the following web-site on `firefox`: ‘https://view.qiime2.org’.
- Click on the ‘Drag and drop or click here’ grey box.
- Use the file browser to find and select the file ‘paired-end-demux.qzv’. 

__Tip__: click "Home" on the top left, from there you can navigate to "Metagenetics" and choose your file.

#### Output {-#chap7output}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/output_file_green.png", auto_pdf = TRUE)
```

The visualisation will have two tabs:

1. __Overview__: This contains 3 main sections relating to the sequence count of samples.
   - __Demultiplexxed sequence counts summary__: Summary table of number of sequences per sample divided by forward and reverse reads.
   - __Read frequency histograms__: Forward and Reverse reads histograms showing the how many samples have various numbers of sequences. 
   - __Per-sample sequence counts__: Table showing the number of forward and reverse reads in samples.
2. __Interactive Quality Plots__: Contains similar information as fastQC analysis.
   - __Interactive quality plots__: These show the quality of your forward and reverse reads using a random sampling of 10000 reads. You can click on a part of the plot to get info in the below "Parametric seven-number summary" table.
   - __Demultiplexed sequence length summary__: Table showing summary of sequence lengths for the forward and reverse reads.

## Import: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_green.png", auto_pdf = TRUE)
```

```{r, echo = FALSE}
opts_p <- c(answer="__42,853__", "__126,670__", "__174,951__")
```
1. What is the minimum number of forward reads across the samples? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__42,853__", "__126,670__", answer="__174,951__")
```
2. What is the maximum number of forward reads across the samples? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__42,853__", answer="__126,670__", "__174,951__")
```
3. What is the mean number of forward reads across the samples? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__1TM__", "__3K2E__", answer="__3K1M__")
```
4. Which sample has 134,737 forward reads? `r longmcq(opts_p)`
 
```{r, echo = FALSE}
opts_p <- c(answer="__1TM__", "__3K2E__", "__3K1M__")
```
5. Which sample has 86,083 forward reads? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__TRUE__", "__FALSE__")
```
6. Most of the read quality for the forward reads is above Q30? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__TRUE__", "__FALSE__")
```
7. Most of the read quality for the reverse reads is above Q30? `r longmcq(opts_p)`

## Import: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_green.png", auto_pdf = TRUE)
```

We have imported our read data and checked the number of reads per sample which looks good. The next step is to remove data from the sequence data we do not need any more.

<!--chapter:end:07-Import_sequences_into_QIIME2.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Trim the PCR primer sequences {#pcrtrim}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/prepare.png", auto_pdf = TRUE)
``` 

Reads are paired-end (R1 and R2) and may overlap in the middle, depending on the size of the sequenced amplicon and the size of the paired reads. Our sequencing data is of the 16S rRNA V4 region (length: ~250bp). Therefore, our 250bp x 2 paired end reads should overlap. If R1 and R2 overlap, we can use this to reconstruct the V4 region by aligning and merging the forward and reverse reads of each pair.

However, before we carry this out we will need to remove any sequence data that is not biologically relevant. This includes the primer sequences that were used in the Illumina sequencing.

## Cutadapt: run
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_black.png", auto_pdf = TRUE)
``` 

We will use the “cutadapt” (Martin, 2011) tool to remove the PCR primer sequences from R1 and R2.

__Note__: You can copy and paste (using right click) the forward and reverse primer from the fasta file "primers_seqs.fasta"

```{bash, eval=FALSE}
#Print primer sequences to screen for copying and pasting
cat primers_seqs.fasta

#Run cutadapt command
qiime cutadapt trim-paired \
--i-demultiplexed-sequences paired-end-demux.qza \
--p-front-f NNNNNGTGCCAGCMGCCGCGGTAA \
--p-front-r GGACTACHVGGGTWTCTAAT \
--o-trimmed-sequences paired-end-demux.trim.qza
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_black.png", auto_pdf = TRUE)
```

- __`--i-demultiplexed-sequences`__: The input demultiplexed sequence artifact.
- __`--p-front-f`__: Sequence for the forward primer (`f`). The sequence is ligated to the 5 prime end (`front`), this is the normal. 
- __`--p-front-r`__: Sequence for the reverse primer (`r`). The sequence is ligated to the 5 prime end (`front`), this is the normal. 
- __`--o-trimmed-sequences`__: The output artifact containing the trimmed sequence data.

[QIIME2 docs on `qiime cutadapt trim-paired`](https://docs.qiime2.org/2023.5/plugins/available/cutadapt/trim-paired/)

## Cutadapt: visualise
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_brown.png", auto_pdf = TRUE)
``` 

To visualise information on the trimmed samples, the following command will create a visualisation artifact associated with the main sample artifact. This is the same visualisation command as in [chapter 7](#chap7_vis) with different a different input and output.

```{bash, eval=FALSE}
qiime demux summarize \
--i-data paired-end-demux.trim.qza \
--o-visualization paired-end-demux.trim.qzv
```

[QIIME2 docs on `qiime demux summarize`](https://docs.qiime2.org/2023.5/plugins/available/demux/summarize/)

Now load the obtained `paired-end-demux.trim.qzv` into the ‘view.qiime2.org’ website.

This visualisation contains the same sections as [`paired-end-demux.qzv`](#chap7output) but contains information on the PCR trimmed data.

If you are working with the ITS region, to trim off the conserved regions from the sequences you can use the ‘q2-itxpress’ plug in. To install and use this plug-in, please see its specific manual: https://library.qiime2.org/plugins/q2-itsxpress/8/

Depending on your experimental design, you may have to perform the trimming of the PCR primer, sequencing adapters and/or using the conserved region using the ‘itsxpress’ trimming only.

## Cutadapt: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_black.png", auto_pdf = TRUE)
```

```{r, echo = FALSE}
opts_p <- c("__1TE__", "__2K2E__", answer="__3K1E__")
```
1. which sample has the lowest number of forward reads? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__1TE__", answer="__2K2E__", "__3K1E__")
```
2. Which sample has the highest number of forward reads? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__<200__", "__200-220__", answer="__>220__")
```
3. Approximately, at which base position do you see a drastic drop of quality in the forward reads (thick bars drop below Q20)? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__<200__", "__200-220__", answer="__>220__")
```
4. Approximately, at which base position do you see a drastic drop of quality in the reverse reads (thick bars drop below Q20)? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__226__", "__230__", "__250__")
```
5. What is the median length of the forward reads? `r longmcq(opts_p)`

## Cutadapt: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_black.png", auto_pdf = TRUE)
```

We have trimmed the adapters from our sequences. This has made the majority of reads shorter going from a length of 250 to >=226. This is expected. We have also kept a good amount of reads and the quality looks good so we can move to denoising.

<!--chapter:end:08-Trim_PCR_sequences.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# (PART\*) ASVs, Taxonomy, and phylogeny {-}

# De-novo amplicon sequence variants identification {#dada2}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/clusters.png", auto_pdf = TRUE)
``` 

We will use DADA2 to denoise and identify the amplicon sequence variants (ASVs) among all the samples. 

## DADA2: run
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_purple.png", auto_pdf = TRUE)
``` 

To perform the variant sequence identification step with DADA2, the command is (__don't run this command, [see below command](#cpdada2)__):

```{bash, eval=FALSE}
qiime dada2 denoise-paired \
--i-demultiplexed-seqs paired-end-demux.trim.qza \
--p-trunc-len-f 220 \
--p-trunc-len-r 220 \
--o-representative-sequences rep-seqs-dada2.qza \
--o-table table-dada2.qza \
--o-denoising-stats dada2-stats.qza \
--verbose
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_purple.png", auto_pdf = TRUE)
```

- __`--i-demultiplexed-seqs`__: Input artifact file containing the trimmed demultiplexed sequences.
- __`--p-trunc-len-f`__: This will truncate (trim) the forward sequences to retain only the first `220` bases.
- __`--p-trunc-len-r`__: This will truncate (trim) the reverse sequences to retain only the first `220` bases.
- __`--o-representative-sequences`__: Output artifact containing the identified sequence variants.
- __`--o-table`__: Output artifact containing the abundance table for the identified variants.
- __`--o-denoising-stats`__: Output artifact containing the sequence numbers pre- and post- trimming and denoising.
- __`--verbose`__: Causes command to display verbose output to screen.

[QIIME2 docs on `qiime dada2 denoise-paired`](https://docs.qiime2.org/2023.5/plugins/available/dada2/denoise-paired/)

### Truncation length
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/measuring_tape.png", auto_pdf = TRUE)
```

We chose `220` for `--p-trunc-len-f` & `--p-trunc-len-r` as the read quality was very good up to the 220 bp position for both the forward and reverse reads.
Additionally, our amplicon length is ~291bp. The combined length of our forward and reverse reads is 440bp, therefore we would have an overlap greater than 100bp which is very good (440 - 291 = 149bp).

As a reminder we are using the primer 515FB-806RB for the V4 16S rRNA gene. The name 515FB-806RB represents the location within an __E.coli__ 16S gene that the primers will hit (515 for the forward, 806 for the reverse). Therefore the amplicon length for __E.coli__ will be 806 - 515 = 291bp. As with all genes this size will vary in length across all the bacterial taxa but only by a few base pairs.

### Copy DADA2 output {#cpdada2}
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/copy.png", auto_pdf = TRUE)
```

The command will take a long time, so stop the command (ctrl+c), if you started it, and copy the final output files, which have been previously made, to your current directory:

```{bash, eval=FALSE}
#Copy the files from the specified directory to your working directory
cp /pub14/tea/nsc206/NEOF/16s_workshop/chapter_9/* ~/Metagenetics
```

Through the above command you will now have the following three files:

- `rep-seqs-dada2.qza`: Artifact containing the identified sequence variants.
- `table-dada2.qza`: Artifact containing the ASV abundance table. 
- `dada2-stats.qza`: Artifact which summarises the statistics after the denoising steps.

### DADA2 considerations
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/considerations.png", auto_pdf = TRUE)
```

This may be one of the longest steps of the whole pipeline. The running time is proportional to the complexity of the sequences (how many ASVs are in the dataset) and to the quality of the sequences (how many errors are present). If this step is taking too long in one of your future projects, you may try to use [‘deblur’](https://docs.qiime2.org/2023.5/plugins/available/deblur/) to de-noise your data (after joining the reads with vsearch), which is generally faster.

In the case of a marker gene with very variable amplicon sequence lengths, as in the case of ITS amplicon sequencing, a possible alternative denoising strategy is to disable the filtering by truncation length using the options: `--p-trunc-len-f 0` and `--p-trunc-len-r 0`. To exclude the low quality tails the `--p-trunc-q 20` option is now required, this option will trim all the sequences after the first base with quality below ‘20’ (this may be very stringent, so you may want to try with lower values as well). A further possibility may be to use only either the forward or reverse read file, for this the `qiime dada2 denoise-single` should be used instead of the above dada2 command.

## table-dada2.qzv {#tabledada2qzv}
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/table.png", auto_pdf = TRUE)
``` 
To visualise information on the ASV table we will run:

```{bash, eval=FALSE}
qiime feature-table summarize \
--i-table table-dada2.qza \
--o-visualization table-dada2.qzv \
--m-sample-metadata-file metadata.file.txt
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_purple.png", auto_pdf = TRUE)
```

- __`--i-table`__: Input artifact file containing the abundance table of the ASVs.
- __`--o-visualization`__: Output visualisation artifact.
- __`--m-sample-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.

[QIIME2 docs on `qiime feature-table summarize`](https://docs.qiime2.org/2023.5/plugins/available/feature-table/summarize/)

#### Output {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/output_file_purple.png", auto_pdf = TRUE)
```

Now load the obtained `table-dada2.qzv` into the ‘view.qiime2.org’ website.

The page opened with `table-dada2.qzv` contains 3 tabs:

1. __Overview__: An overview page with various information.
   - __Table summary__
      - __Number of samples__
      - __Number of features__: In this case features are ASVs. If this was a taxa table features would be the number of taxa.
      - __Total frequency__: Total number of sequences (i.e. total abundance across all samples and ASVs).
   - __Frequency per sample__: Summary of number of sequences.
      - __IQR table__: Table showing the Interquartile range of sample frequencies.
      - __Histogram of frequency per sample__: This gives a rough view as the start and end of the histogram is based on the minimum and maximum sample frequencies.
   - __Frequency per feature__: Summary of number of sequences per feature (ASV/taxa).
      - __IQR table__: Table showing the Interquartile range of feature frequencies.
      - __Histogram of frequency per sample__: This shows a rough view of the number of features (y axis) with different frequencies (x axis). Note that the scales are logarithmic. The left side of the plot shows how many rare ASVs there are (ASVs represented by a low amount of sequences, i.e. low abundance ASVs). The right side of the plot shows the amount of high abundance ASVs.
2. __Interactive Sample Detail__: This interactive section allows you to explore sampling depth. Experiment using the Plot Controls.
   - __Plot__: This shows the number of samples per metadata category.
   - __Feature count table__: Table showing feature count per sample.
   - __Plot Controls__: Controls to change and update the plot and table.
      - __Save as..__: Controls to save the current plot.
      - __Metadata Category__: This allows you to change the values on the x axis of the plot.
      - __Sampling Depth__: Choosing a sampling depth will update the following.
         - __Plot__: The plot will be updated to grey out the tops of the bars by removing samples with a depth lower than the chosen sampling depth.
         - __Feature count table__: Samples with a lower depth than the sampling depth will be highlighted red.
         - __Plot Controls__: Below the controls is a section of text showing the number of features and samples retained by the chosen sampling depth.
3. __Feature detail__: This is a table with 3 columns.
   - 1st column: This is the ASV id. This ID represents the exact amplicon sequence variant. This is useful as if this ASV id is in another sequencing experiment it means they are identical between the two studies. This allows for easy merging of multiple ASV tables.
   - __Frequency__: Number of sequences representing the ASV across all samples. I.e. the total abundance of the ASV.
   - __# of Samples Observed in__: Number of samples the ASVs was detected in.

### table-dada2.qzv: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_purple.png", auto_pdf = TRUE)
```

Attempt the below MCQs.

```{r, echo = FALSE}
opts_p <- c(answer="__2,139__", "__118,703.5__", "__258,440__")
```
1. How many ASVs (features) were detected in the dataset? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__2,139__", answer="__118,703.5__", "__258,440__")
```
2. What is the median number of sequences per sample? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__2,139__", "__118,703.5__", answer="__258,440__")
```
3. What is the maximum number of sequences per ASV? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__4__", "__5__", answer="__13__")
```
4. How many samples have >=100,000 sequences? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__4__", answer="__5__", "__13__")
```
5. How many Toilet (Metadata Category: Location) samples have >=80,00 sequences? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__4__", "__5__", "__13__")
```
6. How many MainBuilding (Metadata Category: Place) samples have >=120,000 sequences? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__15__", answer="__225,752__", "__258,440__")
```
7. How many sequences represent the second most abundant ASV? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__15__", "__225,752__", "__258,440__")
```
8. How many samples is the 10th most abundant ASV observed in? `r longmcq(opts_p)`

## dada2-stats.qzv
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/filter.png", auto_pdf = TRUE)
``` 
Next we'll look at the denoising stats. Run the following command.

```{bash, eval=FALSE}
qiime metadata tabulate \
--m-input-file dada2-stats.qza \
--o-visualization dada2-stats.qzv
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_blue.png", auto_pdf = TRUE)
```

- __`--m-input-file`__: Input artifact file containing the denoising stats from DADA2.
- __`--o-visualization`__: Output visualisation artifact.

[QIIME2 docs on `qiime metadata tabulate`](https://docs.qiime2.org/2023.5/plugins/available/metadata/tabulate/)

#### Output {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/output_file_blue.png", auto_pdf = TRUE)
```

Open the `dada2-stats.qzv` visualisation with QIIME2 view.

You will now see a denoising stats table with the following columns:

- __sample-id__
- __input__: Number of sequence pairs the sample started with prior to the denoising steps.
- __filtered__: Number of sequence pairs retained after user specified filtering (e.g. `--p-trunc-len-f 220` will truncate forward reads but also remove sequence pairs where the forward length is shorter than 220).
- __percentage of input passed filter__: Percentage of input reads that passed the filtering step.
- __denoised__: Number of filtered sequence pairs that were successfully denoised.
- __merged__: Number of filtered and denoised paired sequences that were successfully merged (forward and reverse read merged into one sequence).
- __percentage of input merged__: Percentage of input reads that passed the filtering, denoising, and merging steps.
- __non-chimeric__: Number of filtered, denoised, and merged sequences retained after chimera removal. This is the final number of sequences per sample.
- __percentage of input non-chimeric__: Percentage of input reads retained at the end.

This visualisation is very useful to see where our sequences are being filtered. It is possible to be too stringent and not have enough sequences for some samples. This will give you an idea on how you can repeat the denoising stats with changed options to retain more samples.

### dada2-stats.qzv: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_blue.png", auto_pdf = TRUE)
```

Attempt the below MCQs?

```{r, echo = FALSE}
opts_p <- c(answer="__Filtering__", "__Denoising and merging__", "__Chimera removal__")
```
1. In which DADA2 step were most of the sequences lost? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__1K1MB__", "__1K1E__", answer="__1K2M__")
```
2. Which sample retained the smallest percentage of its input at the end (i.e. after filtering, denoising, merging, and chimera removal)?  `r longmcq(opts_p)`

## DADA2: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_blue.png", auto_pdf = TRUE)
```

Our reads have been filtered, denoised, and merged. Additionally, chimeras have been removed. With this carried out we have an ASV abundance table, representative sequences, and stats on the various steps that have been carried out.

Through visualising the table and stats we can determine that there are a good amount of sequences per sample (>20,000) and there is a good amount of samples per sample group. We are therefore happy with our data and can continue on.

<!--chapter:end:09-ASV_identification.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# ASV taxonomic assignment {#taxa}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/classification.png", auto_pdf = TRUE)
``` 

Now that we have defined the sequence variants in the samples, this chapter will show you how to carry out taxonomic classification using [Greengenes2](https://www.nature.com/articles/s41587-023-01845-1). More information on its use can be found in the following `QIIME2` forum post from one of the Greengenes2 developers: https://forum.qiime2.org/t/introducing-greengenes2-2022-10/25291

## Greengenes2 database
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/green_jeans.png", auto_pdf = TRUE)
``` 

Greengenes2 is a database containing quality-controlled microbial sequence data. It consists of a single massive reference tree that contains taxonomic and sequence information. It was created by combining:

- __Web of Life 2 (WoL2)__: A microbe base phylogenomic tree.
  - __15,953__ bacterial and archaeal genomes.
  - Accurate phylogenomic tree reconstructed by summarising __380__ global marker genes.
  - Produced by new workflow [uDance](https://github.com/balabanmetin/uDance).
- __16s rRNA sequences__ from different sources.
  - __18,356__ full-length 16S rRNA sequences from the [Living Tree Project (LTP)](https://www.nature.com/articles/s41587-020-0501-8) January 2022 release.
  - __1,725,274__ near-complete 16S rRNA genes from [Karst et al 2021](https://www.annualreviews.org/doi/10.1146/annurev-ecolsys-012121-095340) and the [Earth Microbiome Project 500 (EMP500)](https://bmcgenomics.biomedcentral.com/articles/10.1186/1471-2164-16-S10-S1).
  - All full-length 16S rRNA sequences from [GTDB r207](https://gtdb.ecogenomic.org/stats/r207).
- __23,113,447__ short V4 16S rRNA ASVs denoised with Deblur v1.1.0 from [Qiita](https://qiita.ucsd.edu/)
- Mitochondria and chloroplast 16S rRNA from [SILVA v138](https://www.arb-silva.de/documentation/release-138/) using [deep-learning-enabled phylogenetic placement (DEPP)](https://github.com/yueyujiang/DEPP).

This produces a reference tree with the following traits:

- Genome-based relationships (WoL2) were fixed whilst relationships between full-length 16S rRNA sequences were inferred.
- Short fragments were then added independlty from each each with the genome and full-length 16S rRNA relationships fixed.
- The final tree covered __21,074,442__ sequences from __31__ different [EMP Ontology 3 (EMPO3)](https://earthmicrobiome.org/protocols-and-standards/empo/) environments.
- __46.5%__ of species-level leaves were covered by a complete genome.
- Phylogenies are decorated with taxonomic labels.
  - Taxonomy was based on GTDB r207, combined with the LTP January 2022 release.
  - Taxonomy is planned to be updated every 6 months with the latest versions of GTDB & LTP.

[Greengenes phylogenetic tree](https://www.nature.com/articles/s41587-023-01845-1/figures/1)
```{r, fig.align = 'center',out.width= '60%', echo=FALSE }
knitr::include_graphics(path = "figures/greengenes2_phylogeny_tree.png", auto_pdf = TRUE)
``` 

Greengenes2 can be used on shotgun metagenomic data. This can allow you to effectively compare taxonomic data from 16S and Shotgun metagenomic datasets. [Tutorial on clasisifying shotgun metageonimc data with Greengenes2](https://forum.qiime2.org/t/introducing-greengenes2-2022-10/25291#if-you-have-shotgun-metagenomic-data-6).

For your future analysis you can download the databases files from their [ftp site](http://ftp.microbio.me/greengenes_release/2022.10/). However it is also good to check [this site page](http://ftp.microbio.me/greengenes_release/) to see if they have a more recent version when you are analysing your data.

`r hide("Download database files in linux terminal")`
You can download the 2 files you need for Greengenes2 taxonomic classification with the following commands.
```{bash, eval=FALSE}
wget http://ftp.microbio.me/greengenes_release/2022.10/2022.10.backbone.full-length.fna.qza
wget http://ftp.microbio.me/greengenes_release/2022.10/2022.10.backbone.tax.qza
```
Remember to first check if 2022.10 is the most recent version before downloading and using it for your own research.
`r unhide()`

## Extract 16s region of interest
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/scissor_cut.png", auto_pdf = TRUE)
``` 

A classifier training step is required to reach optimum assignment performance.

Prior to training we will extract our 16S region of interest. This is carried out by using the amplicon primer sequences. These are the same we used for [removing the PCR primer](#pcrtrim).

__Note__: Do not run the below command for this tutorial as it will take a long time. See `cp` command further down.

```{bash, eval=FALSE}
qiime feature-classifier extract-reads \
--i-sequences /pub14/tea/nsc206/NEOF/16s_workshop/greengenes2/2022.10.backbone.full-length.fna.qza \
--p-f-primer NNNNNGTGCCAGCMGCCGCGGTAA \
--p-r-primer GGACTACHVGGGTWTCTAAT \
--p-trunc-len 250 \
--o-reads gg2-v4.ref.seqs.qza \
--p-n-jobs 12
```

`r hide("Silva 16S rRNA database")`
Another popular 16S rRNA database is [Silva](https://www.arb-silva.de/).

You can download the required files for taxonomic classification from [here](https://docs.qiime2.org/2023.5/data-resources/#silva-16s-18s-rrna).
`r unhide()`

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_red.png", auto_pdf = TRUE)
```

- __`--i-sequences`__: Input artifact containing the feature sequence data.
  - In this case we are using the full length 16S rRNA sequences that are used within the Greenegenes2 phylogenomic tree.
  - This was downloaded from http://ftp.microbio.me/greengenes_release/2022.10/2022.10.backbone.full-length.fna.qza.
- __`--p-front-f`__: Sequence for the forward primer (`f`). The sequence is ligated to the 5 prime end (`front`), this is the normal. 
- __`--p-front-r`__: Sequence for the reverse primer (`r``). The sequence is ligated to the 5 prime end (`front`), this is the normal.
- __`--p-trunc-len`__: This cuts the forward and left reads we are creating to the specified truncation length.
  - We are using `250` as this was the initial length of our Illumina reads.
- __`--o-reads`__: The output read artifact containing our extracted 16S region as paired reads. This is needed for classifier training.
- __`--p-n-jobs`__: Number of separate processes to use.

[QIIME2 docs on `qiime feature-classifier extract-reads`](https://docs.qiime2.org/2023.5/plugins/available/feature-classifier/extract-reads/)

#### Copy premade results {-}

Given that the above command may require more than 14h to finish, we won’t be able to run it on this occasion. Copy over the pre-made results with the following command:

```{bash, eval=FALSE}
cp /pub14/tea/nsc206/NEOF/16s_workshop/greengenes2/gg2-v4.ref.seqs.qza .
```

## Classifier training
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/train.png", auto_pdf = TRUE)
``` 

Now we train the classifier on this set of extracted reads (approx. 25 mins). 

This uses Naive Bayes which is a very complicated algorithm. Thankfully we don't need to know how it works so we won't explain it here.

__Note__: You can run the code or copy a pre-made file.

```{bash, eval=FALSE}
qiime feature-classifier fit-classifier-naive-bayes \
--i-reference-reads gg2-v4.ref.seqs.qza \
--i-reference-taxonomy /pub14/tea/nsc206/NEOF/16s_workshop/greengenes2/2022.10.backbone.tax.qza \
--o-classifier gg2-v4.classifier.trained.qza
```

Copy pre-made file if you didn't run the code above.

```{bash, eval=FALSE}
cp /pub14/tea/nsc006/NEOF/16s_workshop/greengenes2/gg2-v4.classifier.trained.qza .
```

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_green.png", auto_pdf = TRUE)
```

- __`--i-reference-reads`__: Input artifact containing the extracted 16S region as paired reads.
- __`--i-reference-taxonomy`__: Input artifact containing the taxonomy information of the features.
  - This was downloaded from: http://ftp.microbio.me/greengenes_release/2022.10/2022.10.backbone.tax.qza.
- __`--o-classifier`__: Output artifact containing the trained classifier. This will be used for feature (ASV) taxonomy classification.

[QIIME2 docs on `qiime feature-classifier fit-classifier-naive-bayes`](https://docs.qiime2.org/2023.5/plugins/available/feature-classifier/fit-classifier-naive-bayes/)

## Taxonomy assignment
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/classification.png", auto_pdf = TRUE)
``` 

With our trained classifier we can assign taxonomic assignments to the ASV representative sequences.

```{bash, eval=FALSE}
qiime feature-classifier classify-sklearn \
--i-classifier gg2-v4.classifier.trained.qza \
--p-confidence 0.7 \
--i-reads rep-seqs-dada2.qza \
--o-classification taxonomy.sklearn.qza \
--p-n-jobs 12
```

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_orange.png", auto_pdf = TRUE)
```

- __`--i-classifier`__: Input artifact containing the trained classifier.
- __`--p-confidence`__: Confidence threshold for limiting taxonomic depth.
  - We are using 0.7 as it is the default.
  - Each taxonomic level must reach a confidence level of <= 0.7 to be classified.
  - This could cause an ASV to be classified to Genus level but not species level as the species level assignment had a confidence of <0.7 whilst the confidence of the genus and higher assignments was >=0.7.
- __`--i-reads`__: Input artifact containing the representative sequences of the features (ASVs) to be classified.
- __`--o-classification`__: Output artifact containing the taxonomic assignments of the features (ASVs).
- __`--p-n-jobs`__: Number of separate processes to use.

[QIIME2 docs on `qiime feature-classifier classify-sklearn`](https://docs.qiime2.org/2023.5/plugins/available/feature-classifier/classify-sklearn/)

## Taxonomy bar chart production {#taxabar}
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/bar_charts.png", auto_pdf = TRUE)
``` 

Create a taxonomy-abundance bar-chart visualisation artifact:

```{bash, eval=FALSE}
qiime taxa barplot \
--i-table table-dada2.qza \
--i-taxonomy taxonomy.sklearn.qza \
--m-metadata-file metadata.file.txt \
--o-visualization taxa-bar-plots.dada2.qzv
```

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_blue.png", auto_pdf = TRUE)
```

- __`--i-table`__: Input artifact containing the ASV abundance table.
- __`--i-taxonomy`__: Input artifact containing the taxonomic classifications of the ASVs.
- __`--m-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.
- __`--o-visualization`__: Output visualisation file containing an interactive taxonomy-abundance bar-chart.

The visualisation consists of an interactive taxonomy bar chart. You can specify the taxonomic level to look at, as well as a few sorting and colouring options. Experiment with it and then continue to the MCQ section.

[QIIME2 docs on `qiime taxa barplot`](https://docs.qiime2.org/2023.5/plugins/available/taxa/barplot/)

## Taxonomy: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_blue.png", auto_pdf = TRUE)
```

Attempt the below MCQs.

```{r, echo = FALSE}
opts_p <- c(answer="__Moraxellaceae__", "__Mycobacteriaceae__","__Pseudomonadaceae__")
```
1. At taxonomic level 5, what is the taxon with the highest relative abundance across all the samples? (Note: taxa are ordered form most to least abundant in the legend) `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Moraxellaceae__", answer="__Mycobacteriaceae__", "__Pseudomonadaceae__")
```
2. At taxonomic level 5, what is the most abundant taxon for sample 1TE?  `r longmcq(opts_p)`

__Note__: The "Sort Samples By" drop down will be useful for the following questions. Additionally, switching the "Ascending" (low to high, right sample has the highest relative abundance) drop down to "Descending" may be useful.

```{r, echo = FALSE}
opts_p <- c("__1K2E__", answer="__1TM__", "__3TM__")
```
3. Which sample has the highest relative abundance of the class Actinomycetia (Taxonomic level 3)? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__1K2E__", "__1TM__", "__3TM__")
```
4. Which sample has the lowest relative abundance of the genus Corynebacterium (Taxonomic level 6)? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__1K2E__", "__1TM__", answer="__3TM__")
```
5. Which sample has the fourth highest relative abundance of the phylum Bacteroidota (Taxonomic level 2)? `r longmcq(opts_p)`

## Taxonomy: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_blue.png", auto_pdf = TRUE)
```

We have trimmed and denoised our data, producing ASVs. This has been followed by assigning taxonomic classifications to the ASVs. 

In your future analysis if you have sequenced any samples with known composition (e.g. mock community), now is the time to see if they behave as expected. Do they contain what you expect? You may want to change some steps and/or settings of what you have done so far if the composition does not match what you expect. For example, change the de-noising tool or apply more quality filters to further improve the quality of the sequence under examination.

We are close to carrying out some biodiversity analysis. Before this we will produce a phylogenetic tree in the next chapter.

[QIIME2 documents on training feature classifiers](https://docs.qiime2.org/2023.5/tutorials/feature-classifier/)

<!--chapter:end:10-Taxonomic_assignment.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Phylogenetic tree construction {#phylogeny}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/phylo_tree.png", auto_pdf = TRUE)
``` 

In this section we will obtain a phylogenetic tree of our ASV representative sequences. The final rooted tree will be used to compute phylogenetically aware alpha- and beta-diversity metrics such as Faith’s Phylogenetic Distance (Faith’s PD) and UniFrac distances. This is only carried out on marker regions for which this is possible (therefore excluding ITS and others).

## MAFFT alignment
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/dna_alignment.png", auto_pdf = TRUE)
``` 
The first step is to align our representative sequences against each other. This is very straightforward as 16S amplicon sequences are relatively similar and short in length.

```{bash, eval=FALSE}
qiime alignment mafft \
--i-sequences rep-seqs-dada2.qza \
--o-alignment aligned-rep-seqs.qza
```

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_red.png", auto_pdf = TRUE)
```

- __`--i-sequences`__: Input artifact containing the representative sequences of the features (ASVs) to be aligned.
- __`--o-alignment`__: Output artifact containing the aligned representative sequences.

[QIIME2 docs on `qiime alignment mafft`](https://docs.qiime2.org/2023.5/plugins/available/alignment/mafft/)

## Masking
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/mask.png", auto_pdf = TRUE)
``` 
After alignment non-informative regions are masked. This will make our phylogenetic construction quicker and better.

```{bash, eval=FALSE}
qiime alignment mask \
--i-alignment aligned-rep-seqs.qza \
--p-max-gap-frequency 1.0 \
--p-min-conservation 0.4 \
--o-masked-alignment masked-aligned-rep-seqs.qza
```

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_blue.png", auto_pdf = TRUE)
```

- __`--i-alignment`__: Input artifact containing aligned representative sequences.
- __`--p-max-gap-frequency`__: This determines the relative frequency of gap characters in an aligned column for the column to be retained.
  - This option is provided with a number from 0-1.
  - 0.0 = Columns consisting of <=0% gaps will be retained. I.e. a column must have no gaps to be retained.
  - 1.0 = Columns consisting of <=100% gaps will be retained. I.e. no column will be removed based on number of gaps.
  - 1.0 was chosen as it is the default option. Unless you have good reason this is what you should use for your future 16S analysis.
- __`--p-min-conservation`__: The minimum relative frequency of at least one non-gap character (e.g. A,G,C,T) in a column for that column to be retained.
  - This option is provided with a number from 0-1.
  - 0.4 = A column will  be retained if it contains at least one character that is present in at least 40% of the sequences. 
    - E.g. a column consisting of 25% A, 25% G, 25% C, and 25% T will __not__ be retained.
    - A column consisting of 40% A, 20% G, 20% C, and 20% T __will__ be retained.
    - 0.4 was chosen as it is the default. Unless you have good reason this is what you should use for your future 16S analysis.
- __`--o-masked-alignment`__: Output artifact containing the masked aligned representative sequences.

[QIIME2 docs on `qiime alignment mask`](https://docs.qiime2.org/2023.5/plugins/available/alignment/mask/)

## Un-rooted tree creation with FASTTREE
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/tree_unrooted.png", auto_pdf = TRUE)
``` 
Create an un-rooted maximum-likelihood tree from our masked alignment with the Fasttree 2 tool. 

```{bash, eval=FALSE}
qiime phylogeny fasttree \
--i-alignment masked-aligned-rep-seqs.qza \
--o-tree unrooted-tree.qza
```

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_purple.png", auto_pdf = TRUE)
```

- __`--i-alignment`__: Input artifact containing the masked aligned representative sequences.
- __`--o-tree`__: Output artifact containing the un-rooted tree.

[QIIME2 docs on `qiime phylogeny fasttree`](https://docs.qiime2.org/2023.5/plugins/available/phylogeny/fasttree/)

## Rooted tree creation
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/tree_rooted.png", auto_pdf = TRUE)
``` 
Finally the un-rooted tree is rooted.

```{bash, eval=FALSE}
qiime phylogeny midpoint-root \
--i-tree unrooted-tree.qza \
--o-rooted-tree rooted-tree.qza
```

#### Parameters{-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_black.png", auto_pdf = TRUE)
```

- __`--i-tree`__: Input artifact containing the un-rooted tree
- __`--o-rooted-tree`__: Output artifact containing the rooted tree.

[QIIME2 docs on `qiime phylogeny midpoint-root`](https://docs.qiime2.org/2023.5/plugins/available/phylogeny/midpoint-root/)

## Phylogeny: summary
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_black.png", auto_pdf = TRUE)
```

All these steps should finish in approximately 3 minutes. The final artifact for later use is ‘rooted-tree.qza’. This is a rooted tree that will be used for some biodiversity measures that require phylogenetic information.

The file ‘rooted-tree.qza’ contains a phylogenetic tree that can be exported to a newick file. This is covered in the [supplemental book](http://www.cgr.liv.ac.uk/illum/NEOFworkshops_5bfa93ca0482d69d/16S/16s_supplemental/02-Exporting_artifacts.html#phylogenetic-tree-export).

<!--chapter:end:11-Phylogentic_tree.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# (PART\*) Analysis {-}

# Sequencing depth evaluation {#rarefaction}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/rarefaction.png", auto_pdf = TRUE)
``` 

The detected diversity partly depends on the sampling depths. An incompletely sampled community will appear less diverse than a fully sampled community. 

To compare the diversity between samples we need to account for their different sampling depths. This can be carried out with rarefaction. 
Rarefaction is performed by reducing all the samples to the same sequence count, by random sub-sampling of the sequences.

For example, if we rarefy to a depth of 2000 for all samples:

- Samples with depths of <2000 will be removed.
- Samples with depths of 2000 will be unchanged.
- Samples with depths of >2000 will have all reads removed except for a random subsample of 2000.

Equally sized subsamples are directly comparable among different samples. Additionally, we can progressively sample subsamples from a sample to draw a curve of estimated alpha diversity. The shape of this curve is informative. If the curve plateaus, then increased sampling depth will not increase the estimate of alpha diversity (the community is fully sampled). 

```{r, fig.align = 'center',out.width= '80%', echo=FALSE, fig.cap= "Example rarefaction curve: We can see that Series 1 plateaus at ~7,000 sequences and Series 3 plateaus at ~18,000 sequences whilst Series 2 has not started to plateau."}
knitr::include_graphics(path = "figures/rarefaction_example.png", auto_pdf = TRUE)
``` 

## Rarefaction: run
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_blue.png", auto_pdf = TRUE)
``` 

Given an abundance table (and a phylogenetic tree for calculating phylogenetic distance), we can plot rarefaction curves using different alpha-diversity metrics. Here, we will use diversity metrics ([observed features](#obvs), [Simpson](#simpson), [Shannon](#shannon), [Faith’s PD](#faith)) as well as an evenness metric ([Simpson’s evenness](#simpsone)).

__Note__: See the [appendix](#alphamet) at the end of this bookdown for details on each metric.

You may want to exclude `--i-phylogeny rooted-tree.qza` and `--p-metrics faith_pd` for markers such as ITS where you will not create a phylogenetic tree.

__Important__: This command will take a long time. If this is the last command you run for today that is fine, go ahead and run it. Optionally, you can [copy the output](#cprarefaction) instead of running it.

```{bash, eval=FALSE}
qiime diversity alpha-rarefaction \
--i-table table-dada2.qza \
--i-phylogeny rooted-tree.qza \
--p-min-depth 5000 \
--p-max-depth 130000 \
--p-steps 500 \
--p-iterations 10 \
--m-metadata-file metadata.file.txt \
--p-metrics simpson_e \
--p-metrics simpson \
--p-metrics shannon \
--p-metrics observed_features \
--p-metrics faith_pd \
--o-visualization rarefaction-curve.qzv
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_blue.png", auto_pdf = TRUE)
```

- __`--i-table`__: Input artifact containing the abundance table for the identified variants.
- __`--i-phylogeny`__: Input artifact containing the rooted tree.
- __`--p-min-depth`__: Minimum depth to show in the plot (x-axis).
- __`--p-max-depth`__: Maximum depth to show in the plot (x-axis).
  - The minimum and maximum depth are chosen based on your knowledge of the sample depths. This can be figured out from the ['table-dada2.qzv' file](#tabledada2qzv).
- __`--p-steps`__: The number of rarefaction steps to include between the min and max depth.
  - This means there will be x points on the sequence depth axis (x-axis) in the resulting plot.
  - The more steps there are the longer the command will take to run.
  - In your future analysis it may take some experimentation to get a number of steps that is a good amount. Too many steps and it can be messy, too few steps and it can be uninformative
- __`--p-iterations`__: This is the number of rarefaction tables that will created. The final output is based on the average of these tables.
  - Although a very large number would be very good it would also take a very long time. The number of iterations increase the time by that amount (i.e. 2 iterations takes 2 times more than 1 iteration).
  - Ten iterations is generally a good amount.
- __`--m-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.
- __`--p-metrics`__: This parameter indicates which alpha diversity to use for rarefaction.
  - This parameter can be specified multiple times for different metrics.
- __`--o-visualization`__: Output visualisation artifact containing the rarefaction plots. 

[QIIME2 docs on `qiime diversity alpha-rarefaction`](https://docs.qiime2.org/2023.5/plugins/available/diversity/alpha-rarefaction/)

### Copy rarefaction output {#cprarefaction}
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/copy.png", auto_pdf = TRUE)
```

Instead of running the command you can copy the output to your directory.

```{bash eval=FALSE}
cp /pub14/tea/nsc206/NEOF/16s_workshop/chapter_12/rarefaction-curve.qzv .
```


## Rarefaction: visualise
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_blue.png", auto_pdf = TRUE)
```

Load the output visualisation artifact into QIIME2 view. You can select the alpha diversity __Metric__ to visualise as well as the groupings (__Sample Metadata Column__, where each __BarcodeSequence__ represents a sample). Generally the [__observed_features__](#obvs) metric is the best __Metric__ to view.

The visualisation has two plots. 

- __Top plot: Alpha rarefaction plot.__
   - Primarily used to determine if the richness of the samples has been fully observed or sequenced.
   - If the lines in the plot appear to "plateau" (i.e., becoming a horizontal line), this suggests that collecting additional sequences beyond that sampling depth will not effect the measured metric. E.g. a plateaued observed feature curve indicates there are no more feature to be detected. 
   - If the lines in the observed feature plot do not level out:
      - The richness of the samples may have not been fully observed (because too few sequences were collected).
      - Or it could be an indicator that a lot of sequencing errors remain in the data (which is being mistaken for novel diversity).
- __Bottom plot: Number of samples (Y) against sequencing depth (X)__
   - This is important when grouping samples by metadata.
   - It illustrates the number of samples with different sequencing depths for the groups in the chosen __Sample Metadata Column__.
   - This is useful as when a sample's sequencing depth is lower than the sequencing depth in the rarefaction plot it will no longer be considered in the rarefaction calculation. This can be seen as jitters in the rarefaction curve corresponding to a decrease in number of samples.
      - If the lost sample had a lower value than the average of the group the curve will jitter upwards, as the group average increases. 
      - If the lost sample had a higher value than the average of the group the curve will jitter downwards, as the group average decreases. 

### Rarefaction considerations
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/considerations.png", auto_pdf = TRUE)
```

Choosing a rarefaction threshold for the normalisation step, is ultimately identifying the best trade-off between:

- Retaining sequencing depth within samples.
- Not losing entire samples.

The best choice usually depends on the experimental design. If you have many samples per group you may be able to lose a few samples without losing statistical power for the analysis. If you have few samples per group you may need to choose a lower threshold.

Other considerations for rarefaction threshold:

- Do the samples in one group have lower depths? Although you may be able to retain all the samples in the other groups with a high rarefaction threshold you may remove too much of the low depth group.
- Should your samples have relatively high (e.g. soil microbiomes) or low (e.g. human gut microbiome) diversity. With higher diversity you will need a larger rarefaction threshold.

### Rarefaction: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_blue.png", auto_pdf = TRUE)
```

Attempt the below MCQs.

```{r, echo = FALSE}
opts_p <- c("__10,000__", "__25,000__", answer="__50,000__")
```
1. At approximately what sequencing depth do the rarefaction curves of most of the samples (>90%) plateaue?  `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__Corridor__", "__Toilet__")
```
2. Comparing the two __Locations__, which has higher evenness scores (simpson_e)? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__Corridor__", "__Toilet__")
```
3. Comparing the two __Locations__, which has a higher Faith's PD scores? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__70,000__", answer="__90,000__", "__115,000 __")
```
4. When comparing the two __Places__, at approximately what sequencing depth are there only 6 MainBuilding samples remaining?  `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__70,000__", "__90,000__", answer="__115,000__")
```
5. When comparing the two __Places__, at approximately what sequencing depth are there only 5 Entrance samples remaining? `r longmcq(opts_p)`

## Rarefaction: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_blue.png", auto_pdf = TRUE)
```

For the next step we will use a rarefaction size of 34,583. We have chosen this depth because:

- This will keep all the samples.
- The group based rarefaction curves (__Location__ and __Place__) are plateauing at this depth.
- Many of the individual samples (__BarcodeSequence__) have plateaued at this depth.
- We do not have a lot of samples so we have prioritised keeping them rather than removing samples for a relatively small gain.

How do we know that the very exact number of 34,583 will keep all the samples? Looking at the __Interactive Sample Detail__ section of the [`table-dada2.qzv`](#tabledada2qzv) visualisation we can see that the lowest depth of a sample is 34,583 (3K1E). Generally people will use the depth of a sample as the rarefaction threshold. E.g. if we were going to choose a rarefaction threshold of >50k we'd pick 58,605 as the exact threshold, this is the lowest sample depth >50k (from sample 1K2M). This allows us to use the maximum amount of sequences per sample.

<!--chapter:end:12-Rarefaction.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Diversity analysis {#diversity}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/diversity.png", auto_pdf = TRUE)
``` 

Alpha diversity is a representation of the diversity within a sample. There are many possible metrics for estimating alpha diversity (QIIME2 allows 30 metrics to be estimated), including the [“Shannon” metric](#shannon), the number of [observed features](#obvs) and [Faith’s phylogenetic distance](#faith) (Shannon,
1948, Faith, 1992).

Beta diversity is diversity among different communities. There are many possible metrics to represent the distance among samples (QIIME2 allows 34 to be estimated). We will use the [weighted and unweighted UniFrac metrics](#unifrac_explanation) (Lozupone and Knight, 2005, Lozupone et al., 2007) and the [Bray-Curtis metric](#bray_explanation) (Bray and Curtis, 1957) (More info on these metrics in the appendix).

## Diversity: run 
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_red.png", auto_pdf = TRUE)
``` 

QIIME2 includes a wrapper script to co-investigate alpha- and beta-diversity at the same time. This script includes only a selected list of alpha- and beta-diversity metrics, but these are usually enough to investigate the dataset. It is possible to use different metrics using the single scripts for alpha and beta-diversity (https://docs.qiime2.org/2023.5/plugins/available/diversity/).

```{bash, eval=FALSE}
qiime diversity core-metrics-phylogenetic \
--i-table table-dada2.qza \
--i-phylogeny rooted-tree.qza \
--p-sampling-depth 34583 \
--output-dir dada2-diversity-34583 \
--m-metadata-file metadata.file.txt
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_red.png", auto_pdf = TRUE)
```

- __`--i-table`__: Input artifact containing the abundance table for the identified variants.
- __`--i-phylogeny`__: Input artifact containing the rooted tree.
- __`--p-sampling-depth`__: Sampling depth to rarefy the abundance data table to.
- __`--output-dir`__: Output directory that will contain all the output files form the command.
- __`--m-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.

[QIIME2 docs on `qiime diversity core-metrics-phylogenetic`](https://docs.qiime2.org/2023.5/plugins/available/diversity/core-metrics-phylogenetic/)

#### Output {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/output_file_red.png", auto_pdf = TRUE)
```

This command will produce all the results within the directory specified with the option `--output-dir`. 

These files include:

- __`rarefied_table.qza`__: The abundance table normalised by rarefaction at the specified sampling size.
- __`vector.qza`__: Artifact files containing the calculated alpha diversity values. 
  - These will be used for alpha diversity statistical analysis in [chapter 14](#alpha_div_stats).
- __`distance_matrix.qza`__: Artifact files containing the beta diversity values.
  - These values are in the form of a table containing all pair wise distances between samples.
  - These will be used in beta diversity statistical analysis in [chapter 15](#beta_stats).
- __`pcoa_results.qza`__: PCoA results calculated from the `distance_matrix.qza` files.
  - These were used to create the `emperor.qza` files described below.
  - Generally you will not need these again.
- __`emperor.qzv`__: Visualisation artifact files containing the beta-diversity ordination plots.

In case of ITS or any marker for which it is not possible to obtain a phylogenetic tree, the alternative command to use for the diversity analysis is: `qiime diversity core-metrics`, which lacks the
`--i-phylogeny` option.

<!--chapter:end:13-Diversity_analysis.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Alpha diveristy statistical analysis {#alpha_div_stats}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/alpha_div.png", auto_pdf = TRUE)
``` 

We can carry out some statistical analysis to compare the alpha diversity values between the different metadata data groups.

The QIIME2 pipeline offers two alternative choices: 

- Categorical metadata: Kruskal-Wallis test.
- Numerical metadata: Ranked Spearman (correlation) test.

## Alpha diversity: run 
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_purple.png", auto_pdf = TRUE)
``` 

As we have categorical (Location & Place) and numeric (Floor) metadata columns we will carry out both types of tests. Let's do this for the shannon alpha diversity.

```{bash, eval=FALSE}
#Change directory into the output directory
cd dada2-diversity-34583
# For the Kruskal-Wallis test
qiime diversity alpha-group-significance \
--i-alpha-diversity shannon_vector.qza \
--m-metadata-file ../metadata.file.txt \
--o-visualization shannon-group-significance.kw.qzv
# For the ranked Spearman test
qiime diversity alpha-correlation \
--i-alpha-diversity shannon_vector.qza \
--m-metadata-file ../metadata.file.txt \
--o-visualization shannon-group-significance.rs.qzv
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_purple.png", auto_pdf = TRUE)
```

Although we have used two different commands they both have the same parameters.

- __`--i-alpha-diversity`__: Input artifact file containing the alpha diversity vectors (values).
- __`--m-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.
- __`--o-visualization`__:  Output visualisation artifact containing the box plots and statistical table.

[QIIME2 docs on `qiime diversity alpha-group-significance`](https://docs.qiime2.org/2023.5/plugins/available/diversity/alpha-group-significance/)

[QIIME2 docs on `qiime diversity alpha-correlation`](https://docs.qiime2.org/2023.5/plugins/available/diversity/alpha-correlation/)

## Alpha diversity: visualise
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_purple.png", auto_pdf = TRUE)
```

Load the produced files (`shannon-group-significance.kw.qzv` & `shannon-group-significance.rs.qzv`) into QIIME2 view using 2 chrome tabs. At this point I will remind you to have only one chrome window open which is to be left open. Also make sure to close tabs you don't need any more (always leaving one open).

At the top of both the outputs is a drop down menu labelled __"Column"__ that can be used to display the plot and stats of your chosen metadata grouping. As there was only one numeric column (Floors) there will only be one option in the Ranked Spearman output.

#### Kruskal-Wallis {-}

The Kruskal-Wallis (`shannon-group-significance.kw.qzv`) visualisation artifact contains:

- __Alpha Diversity Boxplots__: Displays the alpha diversity values plotted as box plots comparing the chosen metadata column.
- __Kruskal-Wallis (all groups)__: Displays the stats for the all groups comparison. 
  - These stats will be different to the pairwise comparisons if there are more than 2 groups.
- __Kruskal-Wallis (pairwise)__: Displays the stats for the all the pairwise group comparison. 

To determine if there is a statistical difference between the groups it is best to look at the q-value/s in the pairwise table. The q-value is in essence the multiple comparison corrected p-value. As there is only one pairwise comparison in each of the 2 categorical metadata groupings the q-value is the same as the p-value (no multiple testing carried out).

[Example with more groups in the metadata columns](https://view.qiime2.org/visualization/?type=html&src=https%3A%2F%2Fdocs.qiime2.org%2F2023.5%2Fdata%2Ftutorials%2Fmoving-pictures%2Fcore-metrics-results%2Ffaith-pd-group-significance.qzv)

#### Ranked Spearman {-}

The Ranked Spearman (`shannon-group-significance.rs.qzv`) visualisation artifact contains:

- __Plot__: This plots the alpha diversity values as a scatterplot.
  - The x-axis contains the numeric values form the metadata.
  - The y-axis contains the alpha diversity values.
- __Stats table__: The Spearman ranked correlation statistics table. 

You can look at the p-value to determine if there is a statistical significant correlation between the numeric category and the alpha diversity metric.

### Alpha diversity: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_purple.png", auto_pdf = TRUE)
```

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
1. Is there a statistical significance (q-value <0.05) when comparing the __Locations (Corridor vs Toilet)__ when using __Shannon__ diversity? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
2. Is there a statistical significance (q-value <0.05) when comparing the __Places (Entrance vs MainBuilding)__ when using __Shannon__ diversity? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
3. Is there a statistical significance (P-value <0.05) when comparing the __Floors (1 vs 2 vs 3)__ when using __Shannon__ diversity? ? `r longmcq(opts_p)`

For the below questions you will need to run some more `qiime diversity alpha-group-significance` and `qiime diversity alpha-correlation`. When creating and running these commands ensure you are giving the input and output artifacts the correct names.

If you are are having issue knowing how to run the commands you can look at the box below for the commands.

`r hide("Alpha diversity stats commands")`
```{bash, eval=FALSE}
# Q4: Observed features of Locations
qiime diversity alpha-group-significance \
--i-alpha-diversity observed_features_vector.qza \
--m-metadata-file ../metadata.file.txt \
--o-visualization observed-features-group-significance.kw.qzv
# Q5: Evenness of Locations
qiime diversity alpha-group-significance \
--i-alpha-diversity evenness_vector.qza \
--m-metadata-file ../metadata.file.txt \
--o-visualization evenness-group-significance.kw.qzv
# Q6: Faith's PD of Floors
qiime diversity alpha-correlation \
--i-alpha-diversity faith_pd_vector.qza \
--m-metadata-file ../metadata.file.txt \
--o-visualization faith-pd-group-significance.rs.qzv
```
`r unhide()`

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
4. Is there a statistical significance (q-value <0.05) when comparing the __Locations (Corridor vs Toilet)__ when using __observed features__? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
5. Is there a statistical significance (q-value <0.05) when comparing the __Places (Entrance vs MainBuilding)__ when using __evenness__? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
6. Is there a statistical significance (P-value <0.05) when comparing the __Floors (1 vs 2 vs 3)__ when using __Faith's PD__? `r longmcq(opts_p)`

## Alpha diversity: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_purple.png", auto_pdf = TRUE)
```

We have viewed alpha diversity output but unfortunately found no significant differences between groups. Hopefully in your future projects you will have more samples and more luck. Even though there was no significance difference we could see some patterns in the box plots such as the diversity being higher in one group than an other.

In the next chapter we will look at the beta diversity output and carry out some more statistics.

<!--chapter:end:14-Alpha_diversity.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Beta diversity statistical analysis {#beta_stats}
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/beta_div.png", auto_pdf = TRUE)
``` 

We'll now carry out statistical analysis of the beta diversity ordination plots. We'll use __'PERMANOVA'__ analysis to determine if the separation of samples by metadata groups has statistical significance or if it may have just originated by chance.

## Beta diveristy: PCoA
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/Scatterplot_2.png", auto_pdf = TRUE)
``` 

Before running some statistical analysis let's look at one of the PCoA plots created in the the [`qiime diversity core-metrics-phylogenetic`](#diversity) command.

1. Open the file `weighted_uinifrac_emperor.qzv` in QIIME2 view.
2. Set the __"Select a Color Category"__ drop down to __"Location"__.
3. Clicking and dragging on the plot, manipulate your view of the 3-D plot until you separate the __"Corridor"__ and __"Toilet"__ samples.

We are able to visually separate these two groups in the plot, especially on Axis 2. However, will some statistics back this up?

## Beta diversity: run 
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_green.png", auto_pdf = TRUE)
``` 

To carry this out our first __'PERMANOVA'__ analysis we will use the `weighted_unifrac_distance_matrix.qza` file. It contains all the sample pairwise __weighted unifrac__ dissimilarity distances.

The __'Location'__ metadata column with the __weighted UniFrac__ metric will be used as there appears to be a separation between the Corridor and Toilet samples.

```{bash, eval=FALSE}
qiime diversity beta-group-significance \
--i-distance-matrix weighted_unifrac_distance_matrix.qza \
--m-metadata-file ../metadata.file.txt \
--m-metadata-column Location \
--p-method permanova \
--p-pairwise \
--p-permutations 999 \
--o-visualization weighted-unifrac-significance.location.qzv
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_green.png", auto_pdf = TRUE)
```

- __`--i-distance-matrix`__: Input artifact files containing the beta diversity values.
- __`--m-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.
- __`--m-metadata-column`__: Metadata column within the metadata file to use for the statistical comparison.
- __`--p-method`__: The group significance test to be applied.
  - `permanova` is the default. `anosim` and `permdisp` are the other 2 options.
- __`--p-pairwise`__: This means all pairwise tests between all pairs of groups in addition to the test across all groups will be carried out.
  - The other parameter choice is `--p-no-pairwise` meaning only the test across all groups will be carried out. This can be used if their are a lot of groups in the metadata column that may make the command take too long to run.
- __`--p-permutations`__: The number of permutations to run when computing p-values.
  - The default is `999`.
__`--o-visualization`__: The output artifact containing the visualisation.

[QIIME2 docs on `qiime diversity beta-group-significance`](https://docs.qiime2.org/2023.5/plugins/available/diversity/beta-group-significance/)

## Beta diversity: visualise
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_green.png", auto_pdf = TRUE)
```

Load the resulting visualisation (`weighted-unifrac-significance.location.qzv`) file in QIIME2 view. You will see the following sections:

- __Overview__: An overview of the statistical analysis for the metadata column.
- __Group significance plot__: These boxplots represent all the pairwise distances between the samples in the specified groups.
   - Example: Distances to Corridor plot
      - Corridor boxplot: This boxplot represents all the pairwise distances within the Corridor samples. If you had 3 corridor samples (C1-3) the boxplot would consist of the distances between C1-C2, C1-C3, and C2-C3.
      - Toilet boxplot: This boxplot represents the pairwise distances between all the corridor samples and toilet samples. If you had 3 corridor samples (C1-3) and 2 toilet samples (T1-2) the boxplot would consist of the distances between C1-T1, C1-T2, C2-T1, C2-T2, C3-T1, and C3-T2.
   - With these plots you can see if the distances within a group are smaller than the distances between that group and other groups.
- __Pairwise results__: This section shows the statistical results comparing the different groups in pairwise fashion. The best values to look at are:
   - Sample size: Good to determine if there are enough samples for statistical strength.
   - q-value: Always go for q-values over p-values.
   
[Example with more groups in the metadata column](https://view.qiime2.org/visualization/?type=html&src=https%3A%2F%2Fdocs.qiime2.org%2F2023.5%2Fdata%2Ftutorials%2Fmoving-pictures%2Fcore-metrics-results%2Funweighted-unifrac-body-site-significance.qzv)

### Beta diversity: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_green.png", auto_pdf = TRUE)
```

Attempt the below questions.

__Note__: You will need to run the `qiime diversity beta-group-significance` with different options and view the new files to answer some of the questions.

```{r, echo = FALSE}
opts_p <- c(answer="__Yes__", "__No__")
```
1. Is there a significant difference (q-value <0.05) between __Corridor and Toilet (Location)__ for the __weighted unifrac__ distances when using __PERMANOVA__? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Corridor__", answer="__Toilet__")
```
2. Which sample group, Corridor or Toilet, has larger __weighted unifrac__ distances within the group? I.e. which boxplot has the IQR with the largest values: "Distances to Corridor" - "Corridor" box plot, or "Distances to Toilet", "Toilet" box plot? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__Corridor__", "__Toilet__")
```
3. In the __weighted unifrac__ distances "Distances to Corridor" box plots, which box plot has lower values? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__Yes__", "__No__")
```
4. Is there a significant difference (q-value <0.05) between __Corridor and Toilet (Location)__ for the __Bray Curtis__ distances when using __PERMANOVA__? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
5. Is there a significant difference (q-value <0.05) between __Entrance and MainBuilding (Place)__ for the __Unweighted Unifrac__ distances when using __ANOSIM__? `r longmcq(opts_p)`

### Beta diversity: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_green.png", auto_pdf = TRUE)
```

Viewing the beta diversity ordination plots and the statistical output we can see there is a difference between the Corridor and Toilet samples. However, there does not appear to be a difference between the Entrance and MainBuilding samples from our quick look.

Additionally, the distances within the Corridor samples are smaller than the distances within the Toilet samples. This indicates that the Corridor samples have less variation than the Toilet samples.

If you want to carry out multi-way ADONIS tests you can use the [`qiime diversity adonis` plugin](https://docs.qiime2.org/2023.5/plugins/available/diversity/adonis/).

We know there is a difference between Corridor and Toilet samples, but are there particular organisms associated with this difference? We are going to try to determine that in the next chapter.

<!--chapter:end:15-Beta_diversity_analysis.rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Differential abundance analysis {#differential}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/balance_scale.png", auto_pdf = TRUE)
```

The [ANCOM-BC](https://www.nature.com/articles/s41467-020-17041-7) method aims to identify differentially abundant taxa between sample groups. It is an improvement of the original ANCOM method but with added bias correction. This bias correction aims to account for the bias caused by the difference in sampling/depth across the samples.

Differential abundance analysis aims to detect features (ASVs, taxa, etc.) that have different abundances between groups. This can be used to detect organisms in high abundance in diseased states versus healthy states. This helps determine what are the disease causing organisms. However, it may also detect organisms that are able to survive in the environment rather than those that cause the difference in environment.

If you are still in 'dada2-diversity-34583' directory, please remember to move out:

```{bash, eval=FALSE}
cd ..
```

## Taxa collapse

```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/collapse.png", auto_pdf = TRUE)
```

First, we need to collapse the ASVs into taxa. This is done as seeing which ASVs are differentially abundant with no taxonomic information is not very useful. Let us choose Greengenes2 level 5 which equates to family.

```{bash, eval=FALSE}
qiime taxa collapse \
--i-table table-dada2.qza \
--i-taxonomy taxonomy.sklearn.qza \
--p-level 5 \
--o-collapsed-table table-l5.qza
```

#### Parameters {.unnumbered}

```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_purple.png", auto_pdf = TRUE)
```

-   **`--i-table`**: Input artifact containing the abundance table (non-rarefied) for the identified variants.
-   **`--i-taxonomy`**: Input artifact containing the taxonomic classifications of the ASVs.
-   **`--p-level`**: The taxonomic level at which the features should be collapsed.
    -   In this case the level refers to family. This can be checked via the [taxonomy bar plot artifact](#taxabar)
-   **`--o-collapsed-table`**: Output artifact containing the abundance table for the specified taxa level.

[QIIME2 docs on `qiime taxa collapse`](https://docs.qiime2.org/2023.5/plugins/available/taxa/collapse/)

## ANCOM-BC analysis

```{r, fig.align = 'center',out.width= '30%', echo=FALSE }
knitr::include_graphics(path = "figures/toilet_corridor.png", auto_pdf = TRUE)
```

With our family based abundance table we can carry out ANCOM-BC to produce the differentials file.

```{bash, eval=FALSE}
qiime composition ancombc \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-formula Location \
--o-differentials l5-ancombc-Location.qza
```

#### Parameters {.unnumbered}

```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_blue.png", auto_pdf = TRUE)
```

-   **`--i-table`**: Input artifact containing the abundance table (non-rarefied) we want to carry out ANCOM-BC on.
-   **`--m-metadata-file`**: [Metadata file](#metadata.file.txt) for our samples.
-   **`--p-formula`**: A formula for how the microbial absolute abundances for each taxon depend on the variables within the `metadata`.
    -   In this case we are specifying the metadata column, Location, within the metadata file to use for the statistical analysis. We will therefore see if there is any differentially abundant features between Corridor and Toilet.
    -   Multiple metadata columns and reference groups can be used with an example in the [documentation](https://docs.qiime2.org/2023.5/plugins/available/composition/ancombc/).
-   **`--o-differentials`**: Output artifact containing the calculated differentials. This will be used to produce visualisation artifacts.

[QIIME2 docs on `qiime composition ancombc`](https://docs.qiime2.org/2023.5/plugins/available/composition/ancombc/)

## ANCOMBC tabulate
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/nice_table.png", auto_pdf = TRUE)
```

Next we can create a visualisation artifact containing tabular views of the ANCOM-BC output.

```{bash, eval=FALSE}
qiime composition tabulate \
--i-data l5-ancombc-Location.qza \
--o-visualization l5-ancombc-Location.qzv
```

#### Parameters {.unnumbered}

```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_green.png", auto_pdf = TRUE)
```

-   **`--i-data`**: Input artifact files containing the calculated differentials. 
- **`--o-visualization`**: The output artifact containing the tabular visualisations.

[QIIME2 docs on `qiime composition tabulate`](https://docs.qiime2.org/2023.5/plugins/available/composition/tabulate/)

### ANCOMBC tabulate: visualise

```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_green.png", auto_pdf = TRUE)
```

Load the resulting visualisation (`l5-ancombc-Location.qzv`) file in QIIME2 view.

There are tabs for the tables of five different metrics. These tables have a column for:

- The intercept which can be ignored by most, as we will do
- The value of the non reference group compared to the reference group.

In this case the program chose the reference group as the first group in alphabetical order (Location::Corridor).

`r hide("Change reference group to Toilet")` 
For your interest, you could choose Toilet as the reference group by running the below command.
```{bash, eval=FALSE}
qiime composition ancombc \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-formula Location \
--o-differentials l5-ancombc-Location-Toilet.qza \
--p-reference-levels Location::Toilet
```
`r unhide()`

-   **lfc**: This contains the log (natural log) fold changes with respect to the reference group.
    -   For example The values for LocationToilet would equal LFC(Toilet - Corridor).
    -   A positive value means the abundances are higher in the comparison group (Toilet) and lower in the ref (Corridor).
    -   A negative value means the abundances are lower in the comparison group (Toilet) and higher in the ref (Corridor).
    -   The intercept value is the grand mean and is likely not of interest.
-   **p_val**: The P-value.
-   **q_val**: The Q-value.
    -   Values lower than 0.05 indicate the feature (taxon) is differentially abundant between the reference and comparison group.
-   **se**: The standard error for the LFC values. 
- **w**: The W statistic.
    -   LFC value divided by the standard error.
    -   The further away from 0 this value is the more significant the feature is differentially abundant between groups.

## ANCOMBC bar plots
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/bar_chart_horizontal.png", auto_pdf = TRUE)
```

Next we can create a visualisation artifact containing bar plots of the ANCOM-BC output.

```{bash, eval=FALSE}
qiime composition da-barplot \
--i-data l5-ancombc-Location.qza \
--o-visualization l5-ancombc-Location-barplot.qzv \
--p-level-delimiter ";"
```

#### Parameters {.unnumbered}

```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_red.png", auto_pdf = TRUE)
```

-   **`--i-data`**: Input artifact file containing the calculated differentials.
-   **`--o-visualization`**: The output artifact containing the bar plot visualisations.
-   **`--p-level-delimiter`**: Splits levels of hierarchical taxonomic information.
    -   We chose ";" as Greengenes2 splits the taxonomic levels with this delimiter.
    -   You can check which delimiter is used in your [**"taxa-bar-plot.dada2.qzv" file**](#taxabar).

[QIIME2 docs on `qiime composition da-barplot`](https://docs.qiime2.org/2023.5/plugins/available/composition/da-barplot/)

### ANCOM-BC bar plots: visualise

```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_red.png", auto_pdf = TRUE)
```

Load the resulting visualisation (`l5-ancombc-Location-barplot.qzv`) file in QIIME2 view.

This contains one large bar plot. This displays the LFC values (x-axis) against the features found as differentially abundant (y-axis). The LFC bars also display their standard error as black lines.

**Reminder**: Just like in the tabular visualisation, positive values are in higher abundance in the comparison group (Toilet) compared to the reference group (Corridor). I.e. positive values are enriched in the comparison group compared to the reference group.

You can hover over a bar to view more details on the biomarker (differentially abundant feature).

## ANCOM-BC: MCQs

```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_red.png", auto_pdf = TRUE)
```

Attempt the below MCQs using the table and bar plot visualisation files.

```{r, echo = FALSE}
opts_p <- c(answer="__Clostridiaceae_222000__", "__Gemellaceae__", "__Weeksellaceae__")
```

1.  Which family has the highest positive LFC value? I.e. The family with the highest enrichment in Toilet (comparison) compared to Corridor (reference). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Clostridiaceae_222000__", "__Gemellaceae__", answer="__Weeksellaceae__")
```

2.  Which family has the lowest negative LFC value? I.e. The family with the highest enrichment in Corridor (reference) compared to Toilet (comparison). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Clostridiaceae_222000__", answer="__Gemellaceae__", "__Weeksellaceae__")
```

3.  Which family has a W statistic of -1.080713? `r longmcq(opts_p)`

Run ANCOM-BC analysis for genus level (level 6). You will have to start from the `qiime taxa collapse` command. You can press the up arrow key to go to previous commands and edit them. If you do this remember to change the input and output options. Try running these commands yourself before looking at the contents of the below box.

`r hide("L6 ANCOM commands")`

```{bash, eval=FALSE}
#Collapse taxa
qiime taxa collapse \
--i-table table-dada2.qza \
--i-taxonomy taxonomy.sklearn.qza \
--p-level 6 \
--o-collapsed-table table-l6.qza
#ANCOM-BC
qiime composition ancombc \
--i-table table-l6.qza \
--m-metadata-file metadata.file.txt \
--p-formula Location \
--o-differentials l6-ancombc-Location.qza
#Tabulate
qiime composition tabulate \
--i-data l6-ancombc-Location.qza \
--o-visualization l6-ancombc-Location.qzv
#Bar plots
qiime composition da-barplot \
--i-data l6-ancombc-Location.qza \
--o-visualization l6-ancombc-Location-barplot.qzv \
--p-level-delimiter ";"
```

`r unhide()`

```{r, echo = FALSE}
opts_p <- c("__Chryseobacterium_796703__", answer="__Clostridium_T__",  "__Dialister__")
```

4.  Which genus has the highest positive LFC value? I.e. The genus with the highest enrichment in Toilet (comparison) compared to Corridor (reference). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__Chryseobacterium_796703__", "__Clostridium_T__",  "__Dialister__")
```

5.  Which genus has the lowest negative LFC value? I.e. The genus with the highest enrichment in Corridor (reference) compared to Toilet (comparison). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Chryseobacterium_796703__", "__Clostridium_T__",  answer="__Dialister__")
```

6.  Which genus has a standard error of 0.582710? `r longmcq(opts_p)`

Run ANCOM analysis to compare the family abundances between the 2 places (Entrance vs MainBuilding). We have already collapsed the taxa. Therefore you can rerun the commands from the `qiime composition ancombc` step with changed options. Try running these commands yourself before looking at the contents of the below box.

`r hide("Family ANCOM analysis with Place metadata comman")`
```{bash, eval=FALSE}
#ANCOM-BC
qiime composition ancombc \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-formula Place \
--o-differentials l5-ancombc-Place.qza
#Tabulate
qiime composition tabulate \
--i-data l5-ancombc-Place.qza \
--o-visualization l5-ancombc-Place.qzv
#Bar plots
qiime composition da-barplot \
--i-data l5-ancombc-Place.qza \
--o-visualization l5-ancombc-Place-barplot.qzv \
--p-level-delimiter ";"
```
`r unhide()`

```{r, echo = FALSE}
opts_p <- c(answer="__Akkermansiaceae__", "__Pseudomonadaceae__" , "__Rhodospirillaceae__")
```

7.  Which family has the 3rd highest positive LFC value? I.e. The family with the third highest enrichment in Main building (comparison) compared to Entrance (reference). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Akkermansiaceae__", answer="__Pseudomonadaceae__" , "__Rhodospirillaceae__")
```

8.  Which family has the lowest negative LFC value? I.e. The family with the highest enrichment in Entrance (reference) compared to Main building (comparison). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Akkermansiaceae__", "__Pseudomonadaceae__" , answer="__Rhodospirillaceae__")
```

9.  Which family has a LFC of -0.795598 `r longmcq(opts_p)`

## ANCOM-BC: summary

```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_red.png", auto_pdf = TRUE)
```

We have detected biomarkers when comparing the 2 locations, Corridor and Toilet. This matches the fact we saw a statistical difference between the beta diversity distances of these two groups. The family *Clostridiaceae* was found to be in higher abundance in the Toilet samples. This makes biological sense as this family is known to exist within the human gastrointestinal tract.

That is the last of the analysis. There is only one more chapter on future considerations.

<!--chapter:end:16-Differential_abundance.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# Final consideration {#final}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/finish.png", auto_pdf = TRUE)
``` 

Are the results you obtained with this pipeline making any sense? In a real scenario, you (as the owner of the dataset) are the one with the deepest knowledge of the dataset you are analysing, so it is upon you to answer this question. This answer needs to be inferred by gathering all the information you can on the samples, from literature or biochemical. If the answer is ‘no’, you can consider the following points.

Are there any missing taxa you know should be there? These taxa may be present but are not being detected for a few reasons, first of all, are these represented in the taxonomical database you are using? If no, you should try with a different one (Greengenes2 or Silva). If they are, you can try with different taxonomical assignment methods. If this still does not work, you can change the method to pick up the representative sequence and/or the clustering at the earlier stages of the analysis. 

The failure could be right at the beginning of the project design. It is worth checking if the PCR primers you are using can amplify these species. Are the primers known to impose bias on the community you are amplifying? Are the primers unable to amplify some taxon whose 16S rRNA sequences are too distant from the rest of the community? The literature may be able to help you on this topic.

If you are happy with the composition, you can then explore the ecological differences among your samples. For this there are few other analyses you may want to approach:

+ Inferring ecological interaction networks (SPIEC-EASI).
+ More statistical analyses with STAMP.
+ Or you can import your results in R to analyse them with Phyloseq. We have workshop on this, check our [training webpage](https://neof.org.uk/training/) to see if it is open for registration.

__CONGRATULATIONS YOU HAVE FINISHED THE ANALYSIS!__
If you have still time available you can move onto the Supplemental bookdown.

<!--chapter:end:17-Final_consideration.Rmd-->

```{r include=FALSE, cache=FALSE}
library(webexercises)
```
# (APPENDIX) Appendix {-}

# Resources
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/resources.png", auto_pdf = TRUE)
``` 

## Suggested readings

The QIIME2 tutorials page contains many useful protocols and possible usage for these scripts (https://docs.qiime2.org/2021.2/tutorials/).

The QIIME scripts collection (http://qiime.org/scripts/index.html) includes many other useful scripts that we have not described, each script with its own description and tips for using it. We encourage you to explore this resource.

A large resource containing links to literature on how easy it is to introduce bias into microbiome studies:

http://www.opiniomics.org/the-unbearable-madness-of-microbiome/

Diversity of 16S rRNA Genes within Individual Prokaryotic Genomes Anna Y. Pei, William E. Oberdorf, Carlos W. Nossa, Ankush Agarwal, Pooja Chokshi, Erika A. Gerz, Zhida Jin, Peng Lee, Liying Yang, Michael Poles, Stuart M. Brown, Steven Sotero, Todd DeSantis, Eoin Brodie, Karen Nelson, and Zhiheng Pei (2010) APPLIED AND ENVIRONMENTAL MICROBIOLOGY.

http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2893482/

Analysis, Optimization and Verification of Illumina- Generated 16S rRNA Gene Amplicon Surveys Michael C. Nelson, Hilary G. Morrison, Jacquelynn Benjamino, Sharon L. Grim, Joerg Graf. (2014) PlosONE

http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0094249

Interpreting 16S metagenomic data without clustering to achieve sub-OTU resolution Mikhail Tikhonov, Robert W Leach and Ned S Wingreen (2015) ISME
http://www.nature.com/ismej/journal/v9/n1/full/ismej2014117a.html

De novo clustering methods outperform reference-based methods for assigning 16S rRNA gene sequences to operational taxonomic units Sarah L. Westcott and Patrick D. Schloss (2015) PeerJ

http://www.ncbi.nlm.nih.gov/pmc/articles/PMC4675110/

Waste Not, Want Not: Why Rarefying Microbiome Data Is Inadmissible. Paul J. McMurdie, Susan Holmes (2014) Plos ONE.

http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1003531

Normalization and microbial differential abundance strategies depend upon data characteristics. Sophie Weiss, Zhenjiang Zech Xu, Shyamal Peddada, Amnon Amir, Kyle Bittinger, Antonio Gonzalez, Catherine Lozupone, Jesse R. Zaneveld, Yoshiki Vázquez-Baeza, Amanda Birmingham, Embriette R. Hyde and Rob Knight (2017) Microbiome

https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-017-0237-y

Application of multivariate statiastical techniques in microbial ecology. Paliy O, Shankar V (2016) Molecular Ecology

http://onlinelibrary.wiley.com/doi/10.1111/mec.13536/abstract

Exact sequence variants should replace operational taxonomic units in marker-gene data analysis. Benjamin J Callahan, Paul J McMurdie & Susan P Holmes (2017).

https://www.nature.com/articles/ismej2017119

Optimizing taxonomic classification of marker gene amplicon sequences Nicholas A Bokulich, Benjamin D Kaehler, Jai Ram Rideout, Matthew Dillon, Evan Bolyen, Rob Knight, Gavin A. Huttley, J. Gregory Caporaso

https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-018-0470-z

Denoising the Denoisers: An independent evaluation of microbiome 3 sequence error-correction methods. Nearing Jacob, Douglas Gavin, Comeau Andre, Langille Morngan

https://peerj.com/preprints/26566.pdf

Compositional data analysis of the microbiome: fundamentals, tools, and challenges. Tsilimigras, M.C. and Fodor, A.A.

https://www.sciencedirect.com/science/article/pii/S1047279716300722

## Other useful resources

A list of very useful site to look at for questions, suggestion and protocols

QIIME2 forum: https://forum.qiime2.org

SEQanswers: http://seqanswers.com

ResearchGate: https://www.researchgate.net/topics

## References

- Aitchison J., (1982). The statistical analysis of compositional data. Journal of the Royal Statistical Society. Series B (Methodological), pp.139-177.
- Caporaso, J. G. et al. Global patterns of 16S rRNA diversity at a depth of millions of sequences per sample. Proc Natl Acad Sci USA 108, 4516–4522 (2011)
- Gloor GB, Macklaim JM, Pawlowsky-Glahn V, and Egozcue, JJ. (2017). Microbiome datasets are compositional: and this is not optional. Frontiers in microbiology, 8, p.2224.
- Hugerth, L.W. and Andersson, A.F., 2017. Analysing microbial community composition through amplicon sequencing: from sampling to hypothesis testing. Frontiers in microbiology, 8, p.1561.
- Pollock J, Glendinning L, Wisedchanwet T, and Watson M. The madness of microbiome: Attempting to find consensus “best practice” for 16S microbiome studies. (2018) Appl Env Microbiology
- Rivers, A.R., Weber, K.C., Gardner, T.G., Liu, S. and Armstrong, S.D., 2018. ITSxpress: Software to rapidly trim internally transcribed spacer sequences with quality scores for marker gene analysis. F1000Research, 7.
- Shannon, C.E., 1948. A mathematical theory of communication. Bell system technical journal, 27(3), pp.379-423.
- Weiss S, Zech Xu ZZ, Peddada S, Amir A, Bittinger K, Gonzalez A, Lozupone C, Zaneveld JR, Vázquez-Baeza Y, Birmingham A, Hydev ER, and Knight R. Normalization and microbial differential abundance strategies depend upon data characteristics. (2017) Microbiome. 3;5(1):27
- Werner JJ, Koren O, Hugenholtz P, DeSantis TZ, Walters WA, Caporaso JG, Angenent LT, Knight R, Ley RE. Impact of training sets on classification of high-throughput bacterial 16s rRNA gene surveys. (2012) ISME J. 6(1):94-103.
- Yarza, P., Yilmaz, P., Pruesse, E., Glöckner, F.O., Ludwig, W., Schleifer, K.H., Whitman, W.B., Euzéby, J., Amann, R. and Rosselló-Móra, R., 2014. Uniting the classification of cultured and uncultured bacteria and archaea using 16S rRNA gene sequences. Nature Reviews Microbiology, 12(9), p.635.

__Cutadapt__

Martin M. Cutadapt removes adapter sequences from high-throughput sequencing reads. EMBnet.journal, 17(1):10-12, May 2011.

__QIIME2 (Quantative Insights Into Microbial Ecology)__

Bolyen E, Rideout JR, Dillon MR, Bokulich NA, Abnet C, Al-Ghalith GA, Alexander H, Alm EJ, Arumugam M, Asnicar F, Bai Y, Bisanz JE, Bittinger K, Brejnrod A, Brislawn CJ, Titus Brown C, Callahan BJ,Caraballo-Rodríguez AM, Chase J, Cope E, Da Silva R, Dorrestein PC, Douglas GM, Durall DM, Duvallet C, Edwardson CF, Ernst M, Estaki M, Fouquier J, Gauglitz JM, Gibson DL, Gonzalez A, Gorlick K, Guo J, Hillmann B, Holmes S, Holste H, Huttenhower C, Huttley G, Janssen S, Jarmusch AK, Jiang L, Kaehler B, Kang K, Keefe CR, Keim P, Kelley ST, Knights D, Koester I, Kosciolek T, Kreps J, Langille MGI, Lee J, Ley R, Liu Y, Loftfield E, Lozupone C, Maher M, Marotz C, Martin BD, McDonald D, McIver LJ, Melnik AV, Metcalf JL, Morgan SC, Morton J, Naimey AT, Navas-Molina JA, Nothias LF, Orchanian SB, Pearson T, Peoples SL, Petras D, Preuss ML, Pruesse E, Rasmussen LB, Rivers A, Robeson MS, Rosenthal P, Segata N, Shaffer M, Shiffer A, Sinha R, Song SJ, Spear JR, Swafford AD, Thompson LR, Torres PJ, Trinh P, Tripathi A, Turnbaugh PJ, Ul-Hasan S, van der Hooft JJJ, Vargas F, Vázquez-Baeza Y, Vogtmann E, von Hippel M, Walters W, Wan Y, Wang M, Warren J, Weber KC, Williamson CHD, Willis AD, Xu ZZ, Zaneveld JR, Zhang Y, Knight R, Caporaso JG (2018) QIIME 2: Reproducible, interactive, scalable, and extensible microbiome data science. PeerJ pre-prints

https://www.nature.com/articles/s41587-019-0209-9

__BLAST__

Altschul S.F., Gish W., Miller W., Myers E.W. and Lipman D.J. (1990). Basic local alignment search tool. J. Mol. Biol. 215: 403-410. 

http://blast.ncbi.nlm.nih.gov/Blast.cgi

__Bray-Curtis__

Bray, J. R. and J. T. Curtis. (1957). An ordination of upland forest communities of southern Wisconsin. Ecological Monographs 27:325-349 

__Chao1__

Chao, A. 1984. Non-parametric estimation of the number of classes in a population. Scandinavian Journal ofStatistics, 11:265-270. Colwell, R.K. and Coddington, J.A. 1994. Estimating terrestrial biodiversity through extrapolation. Philosophical Transactions of the Royal Society B: Biological Sciences, 345:101-118.

__DADA2__

Callahan BJ, McMurdie PJ, Rosen MJ, Han AW, Johnson AJA. DADA2: High-resolution sample inference from Illumina amplicon data. Nat Methods. 2016. 13, 581-583.

__GNEISS__

Morton JT, Sanders J, Quinn RA, McDonald D, Gonzalez A, Vázquez-Baeza Y, Navas-Molina JA, Song SJ, Metcalf JL, Hyde ER, Lladser M, Dorrestein PC, Knight R. (2017). Balance Trees Reveal Microbial Niche Differentiation mSystem 17;2(1)

__Greengenes__

DeSantis, T. Z., P. Hugenholtz, N. Larsen, M. Rojas, E. L. Brodie, K. Keller, T. Huber, D. Dalevi, P. Hu, and G. L. Andersen. (2006). Greengenes, a Chimera-Checked 16S rRNA Gene Database and Workbench Compatible with ARB. Appl Environ Microbiol 72:5069-72. 

__Faith’s Phylogenetic Diversity (PD)__

Faith. 1992. Conservation evaluation and phylogenetic diversity. Biological Conservation 61: 1-10

Faith DP and Baker AM. Phylogenetic diversity (PD) and biodiversity conservation: some bioinformatics challenges (2006) Evol. Bioinform. 2: 121–128.

__UniFrac__

Lozupone, C.; Knight, R. (2005). "UniFrac: A New Phylogenetic Method for Comparing Microbial Communities". Applied and Environmental Microbiology 71 (12): 8228–8235

https://aem.asm.org/content/71/12/8228.short

__UniFrac__

Lozupone, Hamady, Kelley & Knight. (2007). "Quantitative and qualitative (beta) diversity measures lead to different insights into factors that structure microbial communities." Appl Environ Microbiol 73 (5): 1576-85

__ANCOM__

Mandal S, Van Treuren W, White RA., Eggesbø M., Knight R., and Peddada, S.D. (2015). Analysis of composition of microbiomes: a novel method for studying microbial composition. Microbial ecology in health and disease, 26(1), p.27663.

# Mamba installs

```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/mamba_logo.png", auto_pdf = TRUE)
```

## Mamba installation and environment {#mamba_install}

Mamba is a reimplementation of conda. It is a great tool for installing bioinformatic packages including R packages.

Mamba github: <https://github.com/mamba-org/mamba>

The best way to use Mamba is to install Miniforge. It has both Conda and Mamba commands.

Miniforge installation: <https://github.com/conda-forge/miniforge>

Mamba guide: <https://mamba.readthedocs.io/en/latest/user_guide/mamba.html>

To create the mamba environment `qiime2-2023.5` run the below commands in your bash. You will need to have installed `mamba` first.

```{bash, eval=FALSE}
#QIIME2
wget https://data.qiime2.org/distro/core/qiime2-2023.5-py38-linux-conda.yml
mamba env create -n qiime2-2023.5 --file qiime2-2023.5-py38-linux-conda.yml
pip install q2-greengenes2
```

__Note__: You may want to install the most recent version of QIIME2. PLease see the following page for installation instructions: https://docs.qiime2.org/2023.5/install/native/

# Diversity metrics
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/metric_square.png", auto_pdf = TRUE)
``` 

## Alpha diversity metrics {#alphamet}
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/alpha_div.png", auto_pdf = TRUE)
``` 

Alpha diversity measures assess the diversity of each sample separately. Generally a higher value of these indexes/measures indicates higher diversity/evenness. 

### Observed features {#obvs}

The observed number of features is defined as the number of distinct features, such as ASVs, within a sample.

The number of observed features can also be known as the feature richness of a sample. A sample with more present features than another would be said to be richer.

### Evenness

How evenly spread the abundances are across all present features.

- A sample with 4 ASVs, each with 25% relative abundance would be perfectly even.
- A sample with 4 ASVs, where one ASV has 97% abundance and the other 3 have 1%, would be highly uneven.

### Faith's PD (phylogenetic diversity) {#faith}

Faith's PD represents the minimum total branch length that covers all taxa within the sample on a phylogenetic tree (Faith, 1992). A smaller PD value indicates a reduced expected taxonomic diversity whilst a large PD value indicates a higher expected diversity.

A sample with 10 ASVs could have a lower Faith's PD than a sample with only 2 ASVs. This could occur if the 10 ASV sample only has ASVs from one genus whilst the 2 ASV samples consists of ASVs from 2 different Families.

```{r, fig.align = 'center',out.width= '60%', echo=FALSE }
knitr::include_graphics(path = "figures/faith_pd.png", auto_pdf = TRUE)
``` 

### Simpson {#simpson}

A measure of diversity based on number of features present and the relative abundance of each feature. If richness and evenness increase the diversity score increases.

__Equation__:
$$
D = 1 - 
{(
\frac
{\sum n{(n-1)}}
{N{(N-1)}}
)}
$$

- D = Simpson diversity index
- n = Abundance of feature
- N = Total feature abundance of sample

The values range from 0 (no diversity) to 1 (infinite diversity).

### Simpson evenness measure (simpson_e) {#simpsone}

This is a measure of evenness based on the Simpson index. It ranges from 0 (lowest eveness) to 1 (complete evenness). It compares the calculated Simpson Index of a sample to its theoretical maximum if the sample was perfectly even but had the same amount of features.

__Equation__:
$$
E_D = 
\frac{D}
{D_m}
$$

- E~D~ = Simpson evenness measure
- D = Simpson diversity index
- D~m~ = Max possible Simpson diveristy index given the number of features

### Shannon {#shannon}

A measure of diversity where a higher number means higher diversity. Shannon's index accounts for both abundance and evenness of the feaures present.

__Equation__:

$$
H =
-\sum_{i=1}^{n} p_i lnp_i
$$

- H = Shannon diversity index
- p = n/N
- n = Abundance of feature
- N = Total feature abundance of sample

## Beta diversity metrics
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/beta_div.png", auto_pdf = TRUE)
``` 

Beta diversity compares 2 samples at a time. This is measured in terms of dissimilarity:

- A lower score indicate the 2 samples are more similar.
- A higher score indicates the 2 samples are more dissimilar.

### Weighted and unweighted UniFrac distances {#unifrac_explanation}

The UniFrac metric is a phylogenetic distance measure between two samples. It is defined as “the sum of the unshared branch lengths between two samples divided by the total branch length (shared + unshared) of two samples” (Lozupone and Knight, 2005). This results in calculating the fraction of the branch lengths unique to each sample (ie. the higher this value is, the more dissimilar two samples are). The entire phylogenetic tree created for all the sequences of all the analysed samples is used for this calculation.

- Unweighted UniFrac: Only considers feature presence/absence.
- Weighted UniFrac: Takes into account feature presence/absence & abundance. I.e. the value is weighted by the abundances.

### Bray-Curtis {#bray_explanation}

The Bray-Curtis metric is a dissimilarity measure that can quantify the level of difference between two samples. Two identical samples would have a Bray-Curtis measure of 0 (i.e. they have 0 dissimilarity).

There are 2 versions but the one used by QIIME2 looks at the number of features shared by the 2 samples.

__Equation__:

$$
CBC = 1 – 
(\frac{2c}
{a + b})
$$

- c = # features present in both samples
- a = # features present in sample a
- b = # features present in sample b

## Diversity Resources

For more diveristy measure please see: https://forum.qiime2.org/t/alpha-and-beta-diversity-explanations-and-commands/2282

<!--chapter:end:18-Appendix.Rmd-->

