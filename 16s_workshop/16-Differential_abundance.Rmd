# Differential abundance analysis {#differential}
<center>
![](figures/balance_scale.png){style="width:200px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

The [ANCOM-BC](https://www.nature.com/articles/s41467-020-17041-7) method aims to identify differentially abundant taxa between sample groups. It is an improvement of the original ANCOM method but with added bias correction. This bias correction aims to account for the bias caused by the difference in sampling/depth across the samples.

Differential abundance analysis aims to detect features (<u id='asv_tip'>ASVs</u>, taxa, etc.) that have different abundances between groups. An example of its use is to detect organisms in high abundance in diseased states versus healthy states. This helps determine what are the disease causing organisms. However, it may also detect organisms that are able to survive in the environment rather than those that cause the difference in environment.

If you are still in 'dada2-diversity-34584' directory, please remember to move out:

```{bash, eval=FALSE}
cd ..
```

## Taxa collapse
<center>
![](figures/collapse.png){style="width:150px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

First, we need to collapse the <u id='asv_tip'>ASVs</u> into taxa. 
This is done as seeing which <u id='asv_tip'>ASVs</u> are differentially abundant with no taxonomic information is not very useful. Let us choose Greengenes2 level 5 which equates to family.

```{bash, eval=FALSE}
qiime taxa collapse \
--i-table table-dada2.qza \
--i-taxonomy taxonomy.sklearn.qza \
--p-level 5 \
--o-collapsed-table table-l5.qza
```

#### Parameters {.unnumbered}
<center>
![](figures/parameter_purple.png){style="width:100px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

-   **`--i-table`**: Input <u id='artifact_tip'>artifact</u> containing the abundance table (non-rarefied) for the identified variants.
-   **`--i-taxonomy`**: Input <u id='artifact_tip'>artifact</u> containing the taxonomic classifications of the <u id='asv_tip'>ASVs</u>.
-   **`--p-level`**: The taxonomic level at which the features should be collapsed.
    -   In this case the level refers to family. This can be checked via the [taxonomy bar plot artifact](#taxabar)
-   **`--o-collapsed-table`**: Output <u id='artifact_tip'>artifact</u> containing the abundance table for the specified taxa level.

[QIIME2 docs on `qiime taxa collapse`](https://amplicon-docs.qiime2.org/en/latest/references/plugins/taxa.html#q2-action-taxa-collapse)

## ANCOM-BC2 analysis
<center>
![](figures/toilet_corridor.png){style="width:300px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

For our analysis we will use ANCOM-BC2.
ANCOM-BC2 extends and efines ANCOM-BC but it is very similar with the same output stats and visualistions. 

With our family based abundance table we can carry out ANCOM-BC2 to produce the differentials file.

```{bash, eval=FALSE}
qiime composition ancombc2 \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-fixed-effects-formula Location \
--o-ancombc2-output l5-abc2-Location.qza
```

#### Parameters {.unnumbered}
<center>
![](figures/parameter_blue.png){style="width:100px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

-   **`--i-table`**: Input <u id='artifact_tip'>artifact</u> containing the abundance table (non-rarefied) we want to carry out ANCOM-BC on.
-   **`--m-metadata-file`**: [Metadata file](#metadata.file.txt) for our samples.
-   **`--p-fixed-effects-formula`**: A formula for how the microbial absolute abundances for each taxon depend on the fixed effects of variables within the `metadata`.
    -   In this case we are specifying the metadata column, Location, within the metadata file to use for the statistical analysis. We will therefore see if there is any differentially abundant features between Corridor and Toilet.
    -   Multiple metadata columns and reference groups can be used with an example in the [documentation](https://docs.qiime2.org/2024.10/plugins/available/composition/ancombc/).
-   **`--o-ancombc2-output`**: Output <u id='artifact_tip'>artifact</u> containing the estimated log fold changes and their standard errors for the variables included in the mixed effects model. This will be used to produce visualisation <u id='artifact_tip'>artifacts</u>.

[QIIME2 docs on `qiime composition ancombc2`](https://amplicon-docs.qiime2.org/en/latest/references/plugins/composition.html#q2-action-composition-ancombc2)

## ANCOM-BC2 tabulate
<center>
![](figures/nice_table.png){style="width:150px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

Next we can create a visualisation <u id='artifact_tip'>artifact</u> containing tabular views of the ANCOM-BC output.

```{bash, eval=FALSE}
qiime composition tabulate \
--i-data l5-abc2-Location.qza \
--o-visualization l5-abc2-Location.qzv
```

#### Parameters {.unnumbered}
<center>
![](figures/parameter_green.png){style="width:100px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

-   **`--i-data`**: Input <u id='artifact_tip'>artifact</u> files containing the calculated differentials. 
- **`--o-visualization`**: The output <u id='artifact_tip'>artifact</u> containing the tabular visualisations.

[QIIME2 docs on `qiime composition tabulate`](https://amplicon-docs.qiime2.org/en/latest/references/plugins/composition.html#q2-action-composition-tabulate)

### ANCOM-BC2 tabulate: visualise
<center>
![](figures/eye_green.png){style="width:150px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

Load the resulting visualisation (`l5-ancombc-Location.qzv`) file in QIIME2 view.

There are tabs for the tables of five different metrics. These tables have a column for:

- The intercept which can be ignored by most, as we will do
- The value of the non reference group compared to the reference group.

In this case the program chose the reference group as the first group in alphabetical order (Location::Corridor).

`r hide("Change reference group to Toilet")` 
For your interest, you could choose Toilet as the reference group by running the below command.
```{bash, eval=FALSE}
qiime composition ancombc2 \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-fixed-effects-formula Location \
--o-ancombc2-output l5-ancombc-Location-Toilet.qza \
--p-reference-levels Location::Toilet
```
`r unhide()`

-   **lfc**: This contains the log (natural log) fold changes with respect to the reference group.
    -   For example The values for LocationToilet would equal LFC(Toilet - Corridor).
    -   A positive value means the abundances are higher in the comparison group (Toilet) and lower in the ref (Corridor).
    -   A negative value means the abundances are lower in the comparison group (Toilet) and higher in the ref (Corridor).
    -   The intercept value is the grand mean and is likely not of interest.
-   **p_val**: The P-value.
-   **q_val**: The Q-value.
    -   Values lower than 0.05 indicate the feature (taxon) is differentially abundant between the reference and comparison group.
-   **se**: The standard error for the LFC values. 
- **w**: The W statistic.
    -   LFC value divided by the standard error.
    -   The further away from 0 this value is the more significant the feature is differentially abundant between groups.

## ANCOM-BC2 bar plots
<center>
![](figures/bar_chart_horizontal.png){style="width:150px; background: white; border-radius:5px"}
</center>

Next we can create a visualisation <u id='artifact_tip'>artifact</u> containing bar plots of the ANCOM-BC2 output.

```{bash, eval=FALSE}
qiime composition ancombc2-visualizer \
--i-data l5-abc2-Location.qza \
--o-visualization l5-abc2-Location-barplot.qzv
```

#### Parameters {.unnumbered}
<center>
![](figures/parameter_red.png){style="width:100px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

-   **`--i-data`**: Input <u id='artifact_tip'>artifact</u> file containing the calculated differentials.
-   **`--o-visualization`**: The output <u id='artifact_tip'>artifact</u> containing the bar plot visualisations.

[QIIME2 docs on `qiime composition ancombc2-visualizer`](http://amplicon-docs.qiime2.org/en/latest/references/plugins/composition.html#q2-action-composition-ancombc2-visualizer)

### ANCOM-BC2 bar plots: visualise
<center>
![](figures/eye_red.png){style="width:150px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

Load the resulting visualisation (`l5-abc2-Location-barplot.qzv`) file in QIIME2 view.

This contains one large bar plot. 
This displays the LFC values (x-axis) against the features found as differentially abundant (y-axis). 
The LFC bars also display their standard error as black lines.

**Reminder**: Just like in the tabular visualisation, positive values are in higher abundance in the comparison group (Toilet) compared to the reference group (Corridor). I.e. positive values are enriched in the comparison group compared to the reference group.

You can hover over a bar to view more details on the biomarker (differentially abundant feature).

## ANCOM-BC2: MCQs
<center>
![](figures/question_bubble_red.png){style="width:150px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

Attempt the below MCQs using the table and bar plot visualisation files.

__Note:__ The bar plot is not very user friendly and you will most likely need to zoom out to see the whole name of the taxa when hovering over a bar.

```{r, echo = FALSE}
opts_p <- c("__Azospirillaceae_507917__", answer="__Clostridiaceae_222000__", "__Gemellaceae__")
```

1.  Which family has the highest positive LFC value? I.e. The family with the highest enrichment in Toilet (comparison) compared to Corridor (reference). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__Azospirillaceae_507917__", "__Clostridiaceae_222000__", "__Gemellaceae__")
```

2.  Which family has the lowest negative LFC value? I.e. The family with the highest enrichment in Corridor (reference) compared to Toilet (comparison). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Azospirillaceae_507917__", "__Clostridiaceae_222000__", answer="__Gemellaceae__")
```

3.  Which family has a W statistic of -1.728954? `r longmcq(opts_p)`

Run ANCOM-BC analysis for genus level (level 6). You will have to start from the `qiime taxa collapse` command. You can press the up arrow key to go to previous commands and edit them. If you do this remember to change the input and output options. Try running these commands yourself before looking at the contents of the below box.

`r hide("L6 ANCOM commands")`

```{bash, eval=FALSE}
#Collapse taxa
qiime taxa collapse \
--i-table table-dada2.qza \
--i-taxonomy taxonomy.sklearn.qza \
--p-level 6 \
--o-collapsed-table table-l6.qza
#ANCOM-BC
qiime composition ancombc2 \
--i-table table-l6.qza \
--m-metadata-file metadata.file.txt \
--p-fixed-effects-formula Location \
--o-ancombc2-output l6-abc2-Location.qza
#Tabulate
qiime composition tabulate \
--i-data l6-abc2-Location.qza \
--o-visualization l6-abc2-Location.qzv
#Bar plots
qiime composition ancombc2-visualizer \
--i-data l6-abc2-Location.qza \
--o-visualization l6-abc2-Location-barplot.qzv
```

`r unhide()`

```{r, echo = FALSE}
opts_p <- c(answer="__Clostridium_T__",  "__Dialister_37762__","__Hymenobacter_910554__")
```

4.  Which genus has the highest positive LFC value? I.e. The genus with the highest enrichment in Toilet (comparison) compared to Corridor (reference). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Clostridium_T__",  "__Dialister_37762__", answer="__Hymenobacter_910554__")
```

5.  Which genus has the 2nd lowest negative LFC value? I.e. The genus with the 2nd highest enrichment in Corridor (reference) compared to Toilet (comparison). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Clostridium_T__",  answer="__Dialister_37762__", "__Hymenobacter_910554__")
```

6.  Which genus has a standard error of 0.343097? `r longmcq(opts_p)`

Run ANCOM analysis to compare the family abundances between the 2 places (Entrance vs MainBuilding). 
We have already collapsed the taxa. 
Therefore you can rerun the commands from the `qiime composition ancombc` step with changed options. 
Try running these commands yourself before looking at the contents of the below box.

`r hide("Family ANCOM analysis with Place metadata comman")`
```{bash, eval=FALSE}
#ANCOM-BC
qiime composition ancombc2 \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-fixed-effects-formula Place \
--o-ancombc2-output l5-abc2-Place.qza
qiime composition tabulate \
--i-data l5-abc2-Place.qza \
--o-visualization l5-abc2-Place.qzv
#Bar plots
qiime composition ancombc2-visualizer \
--i-data l5-abc2-Place.qza \
--o-visualization l5-abc2-Place-barplot.qzv
```
`r unhide()`

```{r, echo = FALSE}
opts_p <- c("__Listeriaceae__" , "__Rhodospirillaceae__", answer="__Solirubrobacteraceae__")
```

7.  Which family has the 3rd highest positive LFC value? I.e. The family with the third highest enrichment in Main building (comparison) compared to Entrance (reference). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c(answer="__Listeriaceae__" , "__Rhodospirillaceae__", "__Solirubrobacteraceae__")
```

8.  Which family has the 2nd lowest negative LFC value? I.e. The family with the 2nd highest enrichment in Entrance (reference) compared to Main building (comparison). `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Listeriaceae__" , answer="__Rhodospirillaceae__", "__Solirubrobacteraceae__")
```

9.  Which family has a LFC of -1.162399 `r longmcq(opts_p)`

## ANCOM-BC: summary
<center>
![](figures/sum_red.png){style="width:150px; border-radius: 5px ; background: white; border: 5px solid white"}
</center>

We have detected biomarkers when comparing the 2 locations, Corridor and Toilet. 
This matches the fact we saw a statistical difference between the <u id='beta_tip'>beta</u> diversity distances of these two groups. 
The family *Clostridiaceae* was found to be in higher abundance in the Toilet samples. 
This makes biological sense as this family is known to exist within the human gastrointestinal tract.

That is the last of the analysis. There is only one more chapter on future considerations.

```{r, echo=FALSE}
#Tippy tooltips
tippy::tippy_this(elementId = "s_tip", 
                  tooltip = "16S ribosomal RNA",
                  arrow = TRUE, placement = "bottom")
tippy::tippy_this(elementId = "otu_tip", 
                  tooltip = "Operational Taxonomy Unit",
                  arrow = TRUE, placement = "bottom")
tippy::tippy_this(elementId = "asv_tip", 
                  tooltip = "Amplicon Sequence Variant",
                  arrow = TRUE, placement = "bottom")
tippy::tippy_this(elementId = "alpha_tip", 
                  tooltip = "Alpha diversity values are based on single samples",
                  arrow = TRUE, placement = "bottom")
tippy::tippy_this(elementId = "beta_tip", 
                  tooltip = "Beta diversity values based on pairwise comparisons",
                  arrow = TRUE, placement = "bottom")
tippy::tippy_this(elementId = "artifact_tip", 
                  tooltip = "Artifact files are specific to QIIME2 and can contain data (.qza) or visualisations (.qzv)",
                  arrow = TRUE, placement = "bottom")
tippy::tippy_this(elementId = "amplicon_tip", 
                  tooltip = "Sequences created by amplifying (e.g. PCR) and sequencing (e.g. Illumina) a targeted region of DNA (e.g. 16S rRNA region)",
                  arrow = TRUE, placement = "bottom")
```