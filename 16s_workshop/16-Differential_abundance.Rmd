# Differential abundance analysis {#differential}
```{r, fig.align = 'center',out.width= '30%', echo=FALSE }
knitr::include_graphics(path = "figures/comparison.png", auto_pdf = TRUE)
``` 

The [ANCOM-BC](https://www.nature.com/articles/s41467-020-17041-7) method aims to identify differentially abundant taxa between sample groups. It is an improvement of the original ANCOM method but with added bias correction. This bias correction aims to account for the bias caused by the difference in sampling/depth across the samples.

Differential abundance analysis aims to detect features (ASVs, taxa, etc.) that have different abundances between groups. This can be used to detect organisms in high abundance in diseased states versus healthy states. This helps determine what are the disease causing organisms. However, it may also detect organisms that are able to survive in the environment rather than those that cause the difference in environment.

If you are still in ‘dada2-diversity-34583’ directory, please remember to move out:

```{bash, eval=FALSE}
cd ..
```

## Taxa collapse
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/collapse.png", auto_pdf = TRUE)
``` 

First, we need to collapse the ASVs into taxa. This is done as seeing which ASVs are differentially abundant with no taxonomic information is not very useful. Let us choose Greengenes2 level 5 which equates to family.

```{bash, eval=FALSE}
qiime taxa collapse \
--i-table table-dada2.qza \
--i-taxonomy taxonomy.sklearn.qza \
--p-level 5 \
--o-collapsed-table table-l5.qza
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_purple.png", auto_pdf = TRUE)
```

- __`--i-table`__: Input artifact containing the abundance table (non-rarefied) for the identified variants.
- __`--i-taxonomy`__: Input artifact containing the taxonomic classifications of the ASVs.
- __`--p-level`__: The taxonomic level at which the features should be collapsed.
  - In this case the level refers to family. This can be checked via the [taxonomy bar plot artifact](#taxabar)
- __`--o-collapsed-table`__: Output artifact containing the abundance table for the specified taxa level.

[QIIME2 docs on `qiime taxa collapse`](https://docs.qiime2.org/2023.5/plugins/available/taxa/collapse/)

## ANCOM-BC analysis
```{r, fig.align = 'center',out.width= '40%', echo=FALSE }
knitr::include_graphics(path = "figures/toilet_corridor.png", auto_pdf = TRUE)
```  

With our genera based abundance table we can carry out ANCOMBC to produce the differentials file.

First, we need to collapse the ASVs into taxa. This is done as seeing which ASVs are differentially abundant with no taxonomic information is not very useful. Let us choose greengenes level 5 which equates to family.

```{bash, eval=FALSE}
qiime composition ancombc \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-formula Location \
--o-differentials l5-ancombc-Location.qza
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_purple.png", auto_pdf = TRUE)
```

- __`--i-table`__: Input artifact containing the abundance table (non-rarefied) we want to carry out ANCOM-BC on.
- __`--m-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.
- __`--p-formula`__: A formula for how the microbial absolute abundances for each taxon depend on the variables within the `metadata`.
  - In this case we are specifying the metadata column within the metadata file to use for the statistical analysis.
  - Multiple metadata columns and reference groups can be used with an example in the [documentation](https://docs.qiime2.org/2023.5/plugins/available/composition/ancombc/).
- __`--o-differentials`__: Output artifact containing the calculated differentials. This will be used to produce visualisation artifacts.

[QIIME2 docs on `qiime composition ancombc`](https://docs.qiime2.org/2023.5/plugins/available/composition/ancombc/)

## ANCOMBC tabulate

Next we can create a visualisation artifact containing tabular views of the ANCOM-BC output.

```{bash, eval=FALSE}
qiime composition tabulate \
--i-data l5-ancombc-Location.qza \
--o-visualization l5-ancombc-Location.qzv
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_green.png", auto_pdf = TRUE)
```

- __`--i-data`__: Input artifact files containing the calculated differentials.
__`--o-visualization`__: The output artifact containing the tabular visualisations.

[QIIME2 docs on `qiime composition tabulate`](https://docs.qiime2.org/2023.5/plugins/available/composition/tabulate/)

### ANCOMBC tabulate: visualise
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_green.png", auto_pdf = TRUE)
```

Load the resulting visualisation (`l5-ancombc-Location.qzv`) file in QIIME2 view. 

There are tabs for the tables of five different metrics. These tables have a column for the intercept (this can be ignored by most as we will do) and the value of the non reference groups compared to the reference group. In this case the reference group was chosen as the first group in alphabetical order (Location::Corridor).

`r hide("Change reference group to Toilet")`
You could choose Toilet as the reference group by running the below command.
```{bash, eval=FALSE}
qiime composition ancombc \
--i-table table-l5.qza \
--m-metadata-file metadata.file.txt \
--p-formula Location \
--o-differentials l5-ancombc-Location-Toilet.qza \
--p-reference-levels Location::Toilet
```
`r unhide()`

- __lfc__: This contains the log (natural log) fold changes with respect to the reference group.
  - For example The values for LocationToilet would equal LFC(Toilet - Corridor).
  - A positive value means the abundances are higher in the comparison group (Toilet) and lower in the ref (Corridor).
  - A negative value means the abundances are lower in the comparison group (Toilet) and higher in the ref (Corridor).
  - The intercept value is the grand mean and is likely not of interest.
- <br>p_val<br>: The P-value.
- <br>a_val<br>: The Q-value.
  - Values lower than 0.05 indicate the feature (taxon) is differentially abundant between the reference and comparison group.
- __se__: The standard error for the LFC values.
__w__: The W statistic. 
  - This is the LFC value divided by the standard error.
  - The further away from 0 this value is the more significant the feature is differentially abundant between groups.

## ANCOMBC bar plots

Next we can create a visualisation artifact containing bar plots of the ANCOM-BC output.

```{bash, eval=FALSE}
qiime composition da-barplot \
--i-data l5-ancombc-Location.qza \
--o-visualization l5-ancombc-Location-barplot.qzv \
--p-level-delimiter ";"
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_green.png", auto_pdf = TRUE)
```

- __`--i-data`__: Input artifact files containing the calculated differentials.
- __`--o-visualization`__: The output artifact containing the bar plot visualisations.
- __--p-level-delimiter__: Split levels of hierarchical taxnomic information.
  - We chose ";" as Greengenes2 splits the taxonomic levels with this delimter.
  - You can check which delimiter is used in your [__"taxa-bar-plot.dada2.qzv" file__](#taxabar)

[QIIME2 docs on `qiime composition da-barplot`](https://docs.qiime2.org/2023.5/plugins/available/composition/da-barplot/)

### ANCOM-BC bar plots: visualise
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/eye_green.png", auto_pdf = TRUE)
```

Load the resulting visualisation (`l5-ancombc-Location-barplot.qzv`) file in QIIME2 view. 

This displays one large bar plot. This displays the LFC values (x-axis) against the features found as differentially abundant (y-axis). The LFC values bars also display their standard error as black lines.

__Reminder__: Just like in the tabular visualisation, positive values are in higher abundance in the comparison group (Toilet) compared to the reference group (Corridor). I.e. positive values are enriched in the comparison group compared to the reference group.

You can hover over a bar to view more details on the biomarker (differentially abundant feature).

## ANCOM-BC: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_red.png", auto_pdf = TRUE)
```

Attempt the below MCQs.

```{r, echo = FALSE}
opts_p <- c(answer="__Clostridiaceae__", "__Moraxellaceae__", "__Pseudomonadaceae__")
```
1. Which family is detected as a biomarker? I.e. which family is differentially abundant between Corridor and Toilet? `r longmcq(opts_p)`

```{r, echo = FALSE}
opts_p <- c("__Corridor__", answer="__Toilet__")
```
2. Which sample group has a higher abundance of the detected biomarker family? `r longmcq(opts_p)`

Run ANCOM analysis for genus level (level 6). You will have to start from the `qiime taxa collapse` command. You can press the up arrow key to go to previous commands and edit them. If you do this remember to change the input and output options. Try running these commands yourself before looking at the contents of the below box.

`r hide("L6 ANCOM commands")`
```{bash, eval=FALSE}
#Collapse taxa
qiime taxa collapse \
--i-table table-dada2.qza \
--i-taxonomy taxonomy.sklearn.qza \
--p-level 6 \
--o-collapsed-table table-l6.qza
#ANCOM-BC
qiime composition ancombc \
--i-table table-l6.qza \
--m-metadata-file metadata.file.txt \
--p-formula Location \
--o-differentials l6-ancombc-Location.qza
#Tabulate
qiime composition tabulate \
--i-data l6-ancombc-Location.qza \
--o-visualization l6-ancombc-Location.qzv
#Bar plots
qiime composition da-barplot \
--i-data l6-ancombc-Location.qza \
--o-visualization l6-ancombc-Location-barplot.qzv \
--p-level-delimiter ";"
```
`r unhide()`

```{r, echo = FALSE}
opts_p <- c("__1__", answer="__2__", "__3__")
```
3. How many genera are discovered as biomarkers? `r longmcq(opts_p)`

Run ANCOM analysis to compare the family abundances between the 2 places (Entrance vs MainBuilding). We have already collapsed and added psuedocounts to create an ANCOM-ready family abundance table. Therefore you will only need to rerun the `qiime composition ancom` with changed options. Try running these commands yourself before looking at the contents of the below box.

`r hide("Family ANCOM analysis with Place metadata comman")`
```{bash, eval=FALSE}
#ANCOM
qiime composition ancom \
--i-table comp-ancom-table-l5-pse.qza \
--m-metadata-file metadata.file.txt \
--m-metadata-column Place \
--o-visualization l5-ancom-Place.qzv
```
`r unhide()`

```{r, echo = FALSE}
opts_p <- c("__Yes__", answer="__No__")
```
4. Are any families discovered as biomarkers when comparing the 2 Places? `r longmcq(opts_p)`

## ANCOM: summary
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/sum_red.png", auto_pdf = TRUE)
```

We have detected biomarkers when comparing the 2 locations, Corridor and Toilet. This matches the fact we saw a statistical difference between the beta diversity distances of these two groups. The family _Clostridiaceae_ was found to be in higher abundance in the Toilet samples. This makes biological sense as this family is known to exist within the human gastrointestinal tract.

In contrast, we found no biomarkers when comparing the Places, Entrance and MainBuilding. This matched with our lack of difference in the beta diversity distances.

That is the last of the analysis. There is only one more chapter on future considerations.

