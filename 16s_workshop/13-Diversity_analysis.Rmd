# Diversity analysis {#diversity}
```{r, fig.align = 'center',out.width= '20%', echo=FALSE }
knitr::include_graphics(path = "figures/diversity.png", auto_pdf = TRUE)
``` 

Alpha diversity is a representation of the diversity within a sample. There are many possible metrics for estimating alpha diversity (QIIME2 allows 30 metrics to be estimated), including the [“Shannon” metric](#shannon), the number of [observed features](#obvs) and [Faith’s phylogenetic distance](#faith) (Shannon,
1948, Faith, 1992).

Beta diversity is diversity among different communities. There are many possible metrics to represent the distance among samples (QIIME2 allows 34 to be estimated). We will use [weighted and unweighted UniFrac metrics](#unifrac_explanation) (Lozupone and Knight, 2005, Lozupoune et al., 2007) and the [Bray-Curtis metric](#bray_explanation) (Bray and Curtis, 1957) (More info on these metrics in the appendix).

## Diversity: run 
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/play_red.png", auto_pdf = TRUE)
``` 

QIIME2 includes a wrapper script to co-investigate alpha- and beta-diversity at the same time. This script includes only a selected list of alpha- and beta-diversity metrics, but these are usually enough to investigate the dataset. It is possible to use different metrics using the single scripts for alpha and beta-diversity (https://docs.qiime2.org/2021.2/plugins/available/diversity/).

```{bash, eval=FALSE}
qiime diversity core-metrics-phylogenetic \
--i-table table-dada2.qza \
--i-phylogeny rooted-tree.qza \
--p-sampling-depth 34583 \
--output-dir dada2-diversity-34583 \
--m-metadata-file metadata.file.txt
```

#### Parameters {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/parameter_red.png", auto_pdf = TRUE)
```

- __`--i-table`__: Input artifact containing the abundance table for the identified variants.
- __`--i-phylogeny`__: Input artifact containing the rooted tree.
- __`--p-sampling-depth`__: Sampling depth to rarefy the abundance data table to.
- __`--output-dir`__: Output directory that will contain all the output files form the command.
- __`--m-metadata-file`__: [Metadata file](#metadata.file.txt) for our samples.

#### Output {-}
```{r, fig.align = 'center',out.width= '10%', echo=FALSE }
knitr::include_graphics(path = "figures/output_file_red.png", auto_pdf = TRUE)
```

This command will produce all the results within the directory specified with the option `--output-dir`. The produced artifact `rarefied_table.qza` is the abundance table normalised by rarefaction at the specified sampling size. The output directory contains artifacts for each used diversity metrics (for alpha- and beta-diversity). The beta-diversity ordination plots are also included in visualisation objects (`emperor.qzv` files).

In case of ITS or any marker for which it is not possible to obtain phylogenetic tree, the alternative command to use for the diversity analysis is: `qiime diversity core-metrics`, which lacks the
`--i-phylogeny` option.

### Diversity: MCQs
```{r, fig.align = 'center',out.width= '15%', echo=FALSE }
knitr::include_graphics(path = "figures/question_bubble_red.png", auto_pdf = TRUE)
```

+ Looking at the beta-diversity plot (`emperor.qzv`), one metric of your choice, is there any metadata category that produces clusters based on the groups? Note: You can reorientate the 3D plot.
+ If you choose a different metric, do you get a different plot/result?
+ Does a different sampling-depth give a different result? Try running the `core-metrics-phylogenetic` command with a different `--p-sampling-depth` and `--output-dir`.